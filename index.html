<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline GST Invoice Generator with Gemini AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F7F4;
            color: #4A4A4A;
        }
        .nav-link {
            @apply px-4 py-2 text-sm font-medium text-gray-600 hover:text-slate-800 hover:bg-gray-100 rounded-md transition-colors;
        }
        .nav-link.active {
            @apply text-slate-800 bg-slate-100 font-semibold;
        }
        .btn-primary {
            @apply bg-slate-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-800 transition-colors shadow-md disabled:bg-gray-300 disabled:cursor-not-allowed disabled:shadow-none;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors shadow-md disabled:bg-gray-200 disabled:cursor-not-allowed disabled:shadow-none;
        }
        .btn-ai {
            @apply bg-gradient-to-r from-slate-600 to-slate-500 text-white font-bold py-2 px-4 rounded-lg hover:from-slate-700 hover:to-slate-600 transition-all shadow-md disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed disabled:shadow-none;
        }
        .btn-danger {
            @apply bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors shadow-md;
        }
        .input-field {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-500 transition-colors bg-white;
        }
        .input-field.invalid {
            @apply border-red-500 ring-1 ring-red-500;
        }
        .validation-message {
            @apply text-red-600 text-xs mt-1;
        }
        .card {
            @apply bg-white p-6 rounded-xl shadow-lg;
        }
        .modal-backdrop {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300;
        }
        .modal-content {
            @apply bg-white rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0;
        }
        .modal-backdrop:not(.hidden) .modal-content {
            @apply scale-100 opacity-100;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4A5568;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        #app-loader {
            @apply fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            @apply fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform transition-all duration-300 z-50;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 250px;
        }
        .status-badge {
            @apply px-2 py-1 text-xs font-medium rounded-full;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app-loader">
        <div class="loader"></div>
        <p class="mt-4 text-gray-600">Loading Your Workspace...</p>
    </div>

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">

        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
            <h1 class="text-3xl font-bold text-gray-800">GST Invoice Generator ‚ú®</h1>
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full sm:w-auto">
                <div class="flex items-center gap-2 bg-white p-2 rounded-lg shadow-sm w-full sm:w-auto">
                    <label for="client-selector" class="text-sm font-medium text-gray-600 whitespace-nowrap">Current Profile:</label>
                    <select id="client-selector" class="input-field !py-1 !px-2 flex-grow"></select>
                </div>
                <nav id="main-nav" class="flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm w-full sm:w-auto justify-between">
                    <a href="#create-invoice" class="nav-link active">Create Invoice</a>
                    <a href="#manage-data" class="nav-link">Manage Data</a>
                    <a href="#reports" class="nav-link">Dashboard & Reports</a>
                    <button id="gst-rate-helper-btn" class="p-2 text-gray-600 hover:text-slate-800" title="GST Rate Helper">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 100-8 4 4 0 000 8z" />
                           <path stroke-linecap="round" stroke-linejoin="round" d="M17 8a4 4 0 100 8 4 4 0 000-8z" />
                           <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6" />
                        </svg>
                    </button>
                    <button id="help-btn" class="p-2 text-gray-600 hover:text-slate-800" title="Invoicing Guide">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </button>
                </nav>
            </div>
        </header>

        <main>
            <section id="create-invoice" class="space-y-6">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Step 1: Document & Transaction Type</h2>
                     <p class="text-sm text-gray-600 mb-4">Start by selecting the type of document you need to create and the nature of the transaction. Your choices here will automatically configure the required fields below to ensure GST compliance.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="document-type" class="block text-sm font-medium text-gray-700 mb-1">Document Type</label>
                            <select id="document-type" class="input-field">
                                <option value="tax_invoice">Tax Invoice</option>
                                <option value="proforma_invoice">Proforma Invoice</option>
                                <option value="bill_of_supply">Bill of Supply</option>
                                <option value="self_invoice_rcm">Self-Invoice (RCM from Unregistered)</option>
                                <option value="debit_note">Debit Note</option>
                                <option value="credit_note">Credit Note</option>
                                <option value="financial_debit_note">Financial Debit Note</option>
                                <option value="financial_credit_note">Financial Credit Note</option>
                                <option value="payment_voucher">Payment Voucher</option>
                                <option value="receipt_voucher">Receipt Voucher</option>
                                <option value="refund_voucher">Refund Voucher</option>
                                <option value="delivery_challan">Delivery Challan</option>
                                <option value="purchase_order">Purchase Order</option>
                                <option value="sales_order">Sales Order</option>
                            </select>
                        </div>
                        <div>
                            <label for="transaction-type" class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
                            <select id="transaction-type" class="input-field">
                                <option value="b2b">B2B (Business to Business)</option>
                                <option value="b2c">B2C (Business to Consumer)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="reverse-charge" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-600">Tax Payable on Reverse Charge</span>
                        </label>
                    </div>
                </div>

                <div id="voucher-form-container" class="hidden">
                     <div class="card">
                        <h2 id="voucher-title" class="text-xl font-semibold mb-4 border-b pb-2">Voucher Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                           <div class="space-y-4">
                                <div>
                                    <label for="voucher-no" class="block text-sm font-medium text-gray-700">Voucher No.</label>
                                    <input type="text" id="voucher-no" class="input-field mt-1" required>
                                </div>
                                <div>
                                    <label for="voucher-date" class="block text-sm font-medium text-gray-700">Voucher Date</label>
                                    <input type="date" id="voucher-date" class="input-field mt-1" required>
                                </div>
                           </div>
                           <div class="space-y-4">
                                <!-- Fields specific to each voucher type will be shown here -->
                                <div id="receipt-voucher-fields" class="hidden space-y-4">
                                    <div>
                                        <label for="advance-amount" class="block text-sm font-medium text-gray-700">Amount of Advance Received (‚Çπ)</label>
                                        <input type="number" id="advance-amount" class="input-field mt-1" required step="0.01">
                                    </div>
                                </div>
                                <div id="refund-voucher-fields" class="hidden space-y-4">
                                     <div>
                                        <label for="original-receipt-voucher-no" class="block text-sm font-medium text-gray-700">Original Receipt Voucher No.</label>
                                        <input type="text" id="original-receipt-voucher-no" class="input-field mt-1" required>
                                    </div>
                                    <div>
                                        <label for="refund-amount" class="block text-sm font-medium text-gray-700">Amount of Refund (‚Çπ)</label>
                                        <input type="number" id="refund-amount" class="input-field mt-1" required step="0.01">
                                    </div>
                                </div>
                                 <div id="payment-voucher-fields" class="hidden space-y-4">
                                    <div>
                                        <label for="payment-amount-voucher" class="block text-sm font-medium text-gray-700">Amount Paid (‚Çπ)</label>
                                        <input type="number" id="payment-amount-voucher" class="input-field mt-1" required step="0.01">
                                    </div>
                                </div>
                           </div>
                        </div>
                        <div class="border-t mt-6 pt-4">
                             <label for="voucher-description" class="block text-sm font-medium text-gray-700">Description of Goods/Services</label>
                             <textarea id="voucher-description" rows="2" class="input-field mt-1" placeholder="Brief description for which this voucher is issued"></textarea>
                        </div>

                         <div class="mt-6 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                              <button id="save-voucher-btn" class="btn-primary">Save Voucher</button>
                        </div>
                    </div>
                </div>

                <div id="invoice-form-container" class="space-y-6">
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2">Step 2: Parties Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <h3 id="supplier-details-header" class="font-semibold text-lg">Supplier Details (You)</h3>
                                <div>
                                    <label for="supplier-name" class="block text-sm font-medium text-gray-700">Name</label>
                                    <input type="text" id="supplier-name" class="input-field mt-1" value="Your Company Name" required>
                                    <span id="supplier-name-error" class="validation-message hidden"></span>
                                </div>
                                <div>
                                    <label for="supplier-gstin" class="block text-sm font-medium text-gray-700">GSTIN</label>
                                    <input type="text" id="supplier-gstin" class="input-field mt-1" value="27ABCDE1234F1Z5">
                                    <span id="supplier-gstin-error" class="validation-message hidden"></span>
                                </div>
                                <div>
                                    <label for="supplier-address" class="block text-sm font-medium text-gray-700">Address</label>
                                    <textarea id="supplier-address" rows="2" class="input-field mt-1" required>123 Business Lane, Mumbai, Maharashtra</textarea>
                                    <span id="supplier-address-error" class="validation-message hidden"></span>
                                </div>
                                <div>
                                    <label for="supplier-pincode" class="block text-sm font-medium text-gray-700">PIN Code</label>
                                    <input type="text" id="supplier-pincode" class="input-field mt-1" required>
                                    <span id="supplier-pincode-error" class="validation-message hidden"></span>
                                </div>
                            </div>
                            <div id="recipient-details-container" class="space-y-4">
                                <h3 class="font-semibold text-lg">Recipient Details (Client)</h3>
                                <div>
                                    <label for="recipient-name" class="block text-sm font-medium text-gray-700">Name</label>
                                    <input type="text" id="recipient-name" class="input-field mt-1" list="customer-datalist" required>
                                    <datalist id="customer-datalist"></datalist>
                                    <span id="recipient-name-error" class="validation-message hidden"></span>
                                </div>
                                <div id="recipient-gstin-container">
                                    <label for="recipient-gstin" class="block text-sm font-medium text-gray-700">GSTIN</label>
                                    <input type="text" id="recipient-gstin" class="input-field mt-1">
                                    <span id="recipient-gstin-error" class="validation-message hidden"></span>
                                </div>
                                <div>
                                    <label for="recipient-address" class="block text-sm font-medium text-gray-700">Billing Address</label>
                                    <textarea id="recipient-address" rows="2" class="input-field mt-1" required></textarea>
                                    <span id="recipient-address-error" class="validation-message hidden"></span>
                                </div>
                                <div>
                                    <label for="recipient-pincode" class="block text-sm font-medium text-gray-700">PIN Code</label>
                                    <input type="text" id="recipient-pincode" class="input-field mt-1" required>
                                    <span id="recipient-pincode-error" class="validation-message hidden"></span>
                                </div>
                                <div id="b2c-details-toggle-container" class="hidden">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="add-recipient-details" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-600">Add recipient details (optional for B2C < ‚Çπ50k)</span>
                                    </label>
                                </div>
                                 <div>
                                    <label class="flex items-center mt-2">
                                        <input type="checkbox" id="same-as-billing" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-600">Delivery address is same as billing</span>
                                    </label>
                                </div>
                                <div id="is-service-invoice-container">
                                    <label class="flex items-center mt-2">
                                        <input type="checkbox" id="is-service-invoice" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-600">This is for services (no delivery address)</span>
                                    </label>
                                </div>
                                <div id="delivery-address-container">
                                    <label for="delivery-address" class="block text-sm font-medium text-gray-700">Delivery Address</label>
                                    <textarea id="delivery-address" rows="2" class="input-field mt-1"></textarea>
                                    <span id="delivery-address-error" class="validation-message hidden"></span>
                                </div>
                                <div>
                                    <label for="place-of-supply" class="block text-sm font-medium text-gray-700">Place of Supply (State)</label>
                                    <select id="place-of-supply" class="input-field mt-1"></select>
                                </div>
                            </div>
                            <div id="unregistered-supplier-details-container" class="hidden space-y-4">
                                <h3 class="font-semibold text-lg">Unregistered Supplier Details</h3>
                                <div>
                                    <label for="unregistered-supplier-name" class="block text-sm font-medium text-gray-700">Name</label>
                                    <input type="text" id="unregistered-supplier-name" class="input-field mt-1">
                                </div>
                                <div>
                                    <label for="unregistered-supplier-address" class="block text-sm font-medium text-gray-700">Address</label>
                                    <textarea id="unregistered-supplier-address" rows="2" class="input-field mt-1"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2">Step 3: Invoice Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                             <div>
                                <label for="invoice-no" class="block text-sm font-medium text-gray-700">Document No.</label>
                                <input type="text" id="invoice-no" class="input-field mt-1" required>
                                <span id="invoice-no-error" class="validation-message hidden"></span>
                            </div>
                            <div>
                                <label for="invoice-date" class="block text-sm font-medium text-gray-700">Document Date</label>
                                <input type="date" id="invoice-date" class="input-field mt-1" required>
                                <span id="invoice-date-error" class="validation-message hidden"></span>
                            </div>
                        </div>
                        <div id="original-doc-details-container" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="original-invoice-no" class="block text-sm font-medium text-gray-700">Original Document No.</label>
                                <input type="text" id="original-invoice-no" class="input-field mt-1">
                            </div>
                            <div>
                                <label for="original-invoice-date" class="block text-sm font-medium text-gray-700">Original Document Date</label>
                                <input type="date" id="original-invoice-date" class="input-field mt-1">
                            </div>
                        </div>
                        <div id="gta-details-container" class="hidden border-t pt-4 mt-4 space-y-4">
                            <h3 class="text-lg font-medium text-gray-800">Goods Transport Agency (GTA) Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="gta-consignor-name" class="block text-sm font-medium text-gray-700">Consignor Name</label>
                                    <input type="text" id="gta-consignor-name" class="input-field mt-1">
                                </div>
                                <div>
                                    <label for="gta-consignee-name" class="block text-sm font-medium text-gray-700">Consignee Name</label>
                                    <input type="text" id="gta-consignee-name" class="input-field mt-1">
                                </div>
                                <div>
                                    <label for="gta-vehicle-no" class="block text-sm font-medium text-gray-700">Vehicle Registration No.</label>
                                    <input type="text" id="gta-vehicle-no" class="input-field mt-1">
                                </div>
                                <div>
                                    <label for="gta-gross-weight" class="block text-sm font-medium text-gray-700">Gross Weight of Consignment</label>
                                    <input type="text" id="gta-gross-weight" class="input-field mt-1" placeholder="e.g., 500 KG">
                                </div>
                                <div>
                                    <label for="gta-place-of-origin" class="block text-sm font-medium text-gray-700">Place of Origin</label>
                                    <input type="text" id="gta-place-of-origin" class="input-field mt-1">
                                </div>
                                <div>
                                    <label for="gta-place-of-destination" class="block text-sm font-medium text-gray-700">Place of Destination</label>
                                    <input type="text" id="gta-place-of-destination" class="input-field mt-1">
                                </div>
                            </div>
                        </div>
                        <div id="credit-note-warning" class="hidden mt-2 text-sm text-yellow-800 bg-yellow-50 p-3 rounded-md">
                           ‚ö†Ô∏è <strong>Attention:</strong> The deadline to adjust GST for this transaction may have passed (30th Nov of the next financial year). You can still issue a financial/commercial credit note without tax adjustment.
                        </div>
                        <div class="overflow-x-auto">
                            <datalist id="product-datalist"></datalist>
                            <table class="w-full text-sm text-left">
                                <thead id="invoice-items-head" class="bg-gray-100">
                                </thead>
                                <tbody id="invoice-items">
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex flex-wrap gap-2">
                             <button id="add-item-btn" class="btn-secondary text-sm">+ Add Item</button>
                             <button id="ai-suggest-item-btn" class="btn-ai text-sm">‚ú® Suggest Item with AI</button>
                        </div>
                    </div>
                    
                    <div id="eway-bill-details-card" class="card hidden">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2">Step 4: E-Way Bill Details (Optional)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="transporter-name" class="block text-sm font-medium text-gray-700">Transporter Name</label>
                                    <input type="text" id="transporter-name" class="input-field mt-1">
                                </div>
                                <div>
                                    <label for="transporter-id" class="block text-sm font-medium text-gray-700">Transporter ID (GSTIN)</label>
                                    <input type="text" id="transporter-id" class="input-field mt-1">
                                </div>
                                 <div>
                                    <label for="trans-mode" class="block text-sm font-medium text-gray-700">Mode of Transport</label>
                                    <select id="trans-mode" class="input-field mt-1">
                                        <option value="1">Road</option>
                                        <option value="2">Rail</option>
                                        <option value="3">Air</option>
                                        <option value="4">Ship</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="reason-for-transport" class="block text-sm font-medium text-gray-700">Reason for Transport</label>
                                    <select id="reason-for-transport" class="input-field mt-1">
                                        <option value="1">Supply</option>
                                        <option value="2">Export</option>
                                        <option value="3">Job Work</option>
                                        <option value="4">For Own Use</option>
                                        <option value="5">Sales Return</option>
                                        <option value="6">Exhibition or Fairs</option>
                                        <option value="10">Others</option>
                                    </select>
                                </div>
                            </div>
                             <div class="space-y-4">
                                <div id="vehicle-no-container">
                                    <label for="vehicle-no" class="block text-sm font-medium text-gray-700">Vehicle No.</label>
                                    <input type="text" id="vehicle-no" class="input-field mt-1">
                                </div>
                                <div id="trans-doc-container" class="hidden space-y-4">
                                    <div>
                                        <label for="trans-doc-no" class="block text-sm font-medium text-gray-700">Transport Document No.</label>
                                        <input type="text" id="trans-doc-no" class="input-field mt-1">
                                    </div>
                                     <div>
                                        <label for="trans-doc-date" class="block text-sm font-medium text-gray-700">Transport Document Date</label>
                                        <input type="date" id="trans-doc-date" class="input-field mt-1">
                                    </div>
                                </div>
                                <div>
                                    <label for="approx-distance" class="block text-sm font-medium text-gray-700">Approx. Distance (in KM)</label>
                                    <input type="number" id="approx-distance" class="input-field mt-1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2">Step 5: Totals & Actions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="packaging-handling-charges" class="block text-sm font-medium text-gray-700">Packaging & Handling Charges</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="number" id="packaging-handling-charges" class="input-field" value="0" step="0.01" min="0">
                                        <div class="relative w-full">
                                            <input type="text" id="packaging-handling-charges-sac" class="input-field pr-10" placeholder="SAC Code">
                                            <button type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-slate-700 auto-fill-sac-btn" data-sac="998549" title="Auto-fill standard SAC for Packaging Services">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="delivery-charges" class="block text-sm font-medium text-gray-700">Delivery Charges</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="number" id="delivery-charges" class="input-field" value="0" step="0.01" min="0">
                                        <div class="relative w-full">
                                            <input type="text" id="delivery-charges-sac" class="input-field pr-10" placeholder="SAC Code">
                                            <button type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-slate-700 auto-fill-sac-btn" data-sac="996511" title="Auto-fill standard SAC for Road Transport Services of Goods">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="cash-handling-charges" class="block text-sm font-medium text-gray-700">Cash Handling Charges</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="number" id="cash-handling-charges" class="input-field" value="0" step="0.01" min="0">
                                        <div class="relative w-full">
                                            <input type="text" id="cash-handling-charges-sac" class="input-field pr-10" placeholder="SAC Code">
                                            <button type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-slate-700 auto-fill-sac-btn" data-sac="997159" title="Auto-fill standard SAC for Other Financial Services">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="rewards-used" class="block text-sm font-medium text-gray-700">Rewards Used (Deduction)</label>
                                    <input type="number" id="rewards-used" class="input-field mt-1" value="0" step="0.01" min="0">
                                </div>
                                <div id="eway-bill-reminder" class="hidden mt-2 text-sm text-blue-600 bg-blue-50 p-2 rounded-md">
                                    üí° <strong>Reminder:</strong> The invoice value exceeds ‚Çπ50,000. An E-Way Bill is likely required for the movement of these goods.
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <div class="w-full md:w-2/3 space-y-2 text-sm">
                                    <div class="flex justify-between"><span>Subtotal:</span> <span id="summary-subtotal">‚Çπ0.00</span></div>
                                    <div class="flex justify-between"><span>Packaging & Handling:</span> <span id="summary-packaging-handling">‚Çπ0.00</span></div>
                                    <div class="flex justify-between"><span>Delivery Charges:</span> <span id="summary-delivery">‚Çπ0.00</span></div>
                                    <div class="flex justify-between"><span>Cash Handling:</span> <span id="summary-cash-handling">‚Çπ0.00</span></div>
                                    <div id="tax-summary-container" class="border-t pt-2 mt-2">
                                        <div class="flex justify-between"><span>CGST:</span> <span id="summary-cgst">‚Çπ0.00</span></div>
                                        <div class="flex justify-between"><span>SGST/UTGST:</span> <span id="summary-sgst">‚Çπ0.00</span></div>
                                        <div class="flex justify-between"><span>IGST:</span> <span id="summary-igst">‚Çπ0.00</span></div>
                                        <div class="flex justify-between"><span>Cess:</span> <span id="summary-cess">‚Çπ0.00</span></div>
                                    </div>
                                    <div class="flex justify-between"><span>Round Off:</span> <span id="summary-roundoff">‚Çπ0.00</span></div>
                                    <div id="summary-total-before-rewards-container" class="flex justify-between font-bold border-t pt-2 mt-2"><span>Total Before Rewards:</span> <span id="summary-total-before-rewards">‚Çπ0.00</span></div>
                                    <div class="flex justify-between text-green-600"><span>Rewards Used:</span> <span>- ‚Çπ<span id="summary-rewards">0.00</span></span></div>
                                    <div class="flex justify-between font-bold text-lg border-t pt-2 mt-2"><span>Grand Total:</span> <span id="summary-total">‚Çπ0.00</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end items-center gap-4">
                            <label for="invoice-copy-type" class="text-sm font-medium text-gray-700">Select Invoice Copy for PDF</label>
                            <select id="invoice-copy-type" class="input-field w-auto">
                                <option value="Original for Recipient">Original for Recipient</option>
                                <option value="Duplicate for Transporter">Duplicate for Transporter</option>
                                <option value="Triplicate for Supplier">Triplicate for Supplier</option>
                            </select>
                        </div>
                         <div id="action-buttons" class="mt-2 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                              <button id="new-invoice-btn" class="btn-secondary">New Invoice</button>
                              <button id="draft-email-btn" class="btn-ai">‚ú® Draft Email</button>
                              <button id="generate-eway-json-btn" class="btn-primary">Generate E-Way Bill Data (JSON)</button>
                              <button id="save-draft-btn" class="btn-secondary">Save Document</button>
                              <button id="generate-pdf-btn" class="btn-primary">Save as PDF</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="manage-data" class="hidden space-y-6">
                <div class="card">
                     <h2 class="text-xl font-semibold mb-4">Data Management</h2>
                     <p class="text-sm text-gray-600 mb-4">Manage your master data for products, customers, and suppliers here. Keeping this information accurate is key to fast and error-free invoicing. Use Profiles to manage data for different businesses.</p>
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="tab-profiles" class="tab-btn border-b-2 border-slate-700 text-slate-700 whitespace-nowrap py-4 px-1 text-sm font-medium">Profiles</button>
                            <button id="tab-products" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 text-sm font-medium">Products</button>
                            <button id="tab-customers" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 text-sm font-medium">Customers</button>
                            <button id="tab-daily-sales" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 text-sm font-medium">Daily Sales</button>
                            <button id="tab-recurring" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 text-sm font-medium">Recurring</button>
                            <button id="tab-expenses" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 text-sm font-medium">Expenses</button>
                            <button id="tab-backup" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 text-sm font-medium">Backup & Restore</button>
                        </nav>
                    </div>
                    <div id="profiles-content" class="mt-6">
                        <div id="profile-list-manage" class="space-y-2 my-4"></div>
                        <form id="add-profile-form-manage" class="flex space-x-2">
                            <input type="text" id="new-profile-name-manage" class="input-field" placeholder="New Profile Name (e.g., My Side Business)" required>
                            <button type="submit" class="btn-primary">Add Profile</button>
                        </form>
                    </div>
                    <div id="products-content" class="hidden mt-6">
                        <h3 class="text-lg font-semibold mb-2">Product Master (PIM)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr><th class="p-2">Name</th><th class="p-2">HSN/SAC</th><th class="p-2">Unit</th><th class="p-2">Rate</th><th class="p-2">GST %</th><th class="p-2">Actions</th></tr>
                                </thead>
                                <tbody id="products-table"></tbody>
                            </table>
                        </div>
                         <div class="mt-4 flex space-x-2">
                            <button id="add-product-btn" class="btn-secondary text-sm">+ Add Product</button>
                            <button id="import-products-btn" class="btn-secondary text-sm">Import from Excel</button>
                        </div>
                    </div>
                    <div id="customers-content" class="hidden mt-6">
                        <h3 class="text-lg font-semibold mb-2">Customer Master</h3>
                         <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr><th class="p-2">Name</th><th class="p-2">GSTIN</th><th class="p-2">State</th><th class="p-2">PIN Code</th><th class="p-2">Actions</th></tr>
                                </thead>
                                <tbody id="customers-table"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <button id="add-customer-btn" class="btn-secondary text-sm">+ Add Customer</button>
                            <button id="import-customers-btn" class="btn-secondary text-sm">Import from Excel</button>
                        </div>
                    </div>
                    <div id="daily-sales-content" class="hidden mt-6">
                        <h3 class="text-lg font-semibold mb-2">Daily Sales Register (for B2C sales < ‚Çπ200)</h3>
                        <p class="text-sm text-gray-600 mb-4">Log small B2C sales here. At the end of the day, you can generate a single consolidated invoice for all of these transactions.</p>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <form id="daily-sale-form" class="grid grid-cols-1 md:grid-cols-7 gap-3 items-end">
                                <div>
                                    <label for="daily-sale-date" class="block text-xs font-medium text-gray-600">Sale Date</label>
                                    <input type="date" id="daily-sale-date" class="input-field mt-1" required>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="daily-sale-item" class="block text-xs font-medium text-gray-600">Item Name</label>
                                    <input type="text" id="daily-sale-item" class="input-field mt-1" list="product-datalist" placeholder="e.g., Coffee" required>
                                </div>
                                <div>
                                    <label for="daily-sale-hsn" class="block text-xs font-medium text-gray-600">HSN/SAC</label>
                                    <input type="text" id="daily-sale-hsn" class="input-field mt-1" required>
                                </div>
                                <div>
                                    <label for="daily-sale-qty" class="block text-xs font-medium text-gray-600">Qty</label>
                                    <input type="number" id="daily-sale-qty" class="input-field mt-1" value="1" required>
                                </div>
                                <div>
                                    <label for="daily-sale-rate" class="block text-xs font-medium text-gray-600">Rate (‚Çπ)</label>
                                    <input type="number" id="daily-sale-rate" class="input-field mt-1" required step="0.01">
                                </div>
                                <button type="submit" class="btn-primary w-full">Log Sale</button>
                            </form>
                            <p id="daily-sale-total-error" class="text-red-600 text-xs mt-2 hidden">Total value cannot exceed ‚Çπ200 for a single entry.</p>
                        </div>

                        <div class="mt-6">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold">Logged Sales for <span id="selected-date-display"></span></h4>
                                <button id="generate-consolidated-invoice-btn" class="btn-primary" disabled>Generate Consolidated Invoice</button>
                            </div>
                            <div class="overflow-x-auto border rounded-lg">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-2 text-left">Item Name</th>
                                            <th class="p-2 text-left">HSN/SAC</th>
                                            <th class="p-2 text-right">Qty</th>
                                            <th class="p-2 text-right">Rate</th>
                                            <th class="p-2 text-right font-semibold">Total</th>
                                            <th class="p-2 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-sales-table">
                                        <tr><td colspan="6" class="p-4 text-center text-gray-500">No sales logged for today.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="recurring-content" class="hidden mt-6">
                        <h3 class="text-lg font-semibold mb-2">Recurring Invoice Schedules</h3>
                         <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr><th class="p-2">Customer</th><th class="p-2">Amount</th><th class="p-2">Frequency</th><th class="p-2">Next Due Date</th><th class="p-2">Actions</th></tr>
                                </thead>
                                <tbody id="recurring-table"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="expenses-content" class="hidden mt-6">
                        <h3 class="text-lg font-semibold mb-2">Expense Tracking</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2">Date</th>
                                        <th class="p-2">Category</th>
                                        <th class="p-2">Description</th>
                                        <th class="p-2">Amount</th>
                                        <th class="p-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-table"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <button id="add-expense-btn" class="btn-secondary text-sm">+ Add Expense</button>
                        </div>
                    </div>
                    <div id="backup-content" class="hidden mt-6 space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Backup Current Profile Data</h3>
                            <p class="text-sm text-gray-600 mb-4">Download a JSON file containing all data for the currently selected profile. Keep this file in a safe place.</p>
                            <button id="backup-data-btn" class="btn-primary">Backup Data (JSON)</button>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Restore Profile Data</h3>
                            <p class="text-sm text-gray-600 mb-4">Upload a previously saved JSON backup file to restore your data. <strong class="text-red-600">Warning:</strong> This will overwrite all existing data for the current profile.</p>
                            <div class="flex items-center space-x-2">
                                <input type="file" id="restore-file-input" class="input-field" accept=".json">
                                <button id="restore-data-btn" class="btn-danger">Restore Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="reports" class="hidden space-y-6">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-6">Financial Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <h3 class="text-sm font-medium text-blue-800">Total Billed</h3>
                            <p id="kpi-total-billed" class="text-2xl font-bold text-blue-900">‚Çπ0.00</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <h3 class="text-sm font-medium text-green-800">Total Collected</h3>
                            <p id="kpi-total-collected" class="text-2xl font-bold text-green-900">‚Çπ0.00</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <h3 class="text-sm font-medium text-red-800">Total Outstanding</h3>
                            <p id="kpi-total-outstanding" class="text-2xl font-bold text-red-900">‚Çπ0.00</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-semibold mb-4 text-center">Invoice Status</h3>
                            <div class="chart-container mx-auto max-w-xs">
                                <canvas id="invoice-status-chart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-4 text-center">Top 5 Customers</h3>
                            <div class="chart-container">
                                <canvas id="top-customers-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Accounts Receivable Aging</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 text-left">Customer</th>
                                    <th class="p-2 text-right">Current</th>
                                    <th class="p-2 text-right">1-30 Days</th>
                                    <th class="p-2 text-right">31-60 Days</th>
                                    <th class="p-2 text-right">61-90 Days</th>
                                    <th class="p-2 text-right">90+ Days</th>
                                    <th class="p-2 text-right font-bold">Total Due</th>
                                </tr>
                            </thead>
                            <tbody id="aging-report-table"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">GST Summary Report</h2>
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex-1 w-full">
                            <label for="gst-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="gst-start-date" class="input-field mt-1">
                        </div>
                        <div class="flex-1 w-full">
                            <label for="gst-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="gst-end-date" class="input-field mt-1">
                        </div>
                        <button id="generate-gst-report" class="btn-primary w-full sm:w-auto mt-2 sm:mt-6">Generate Report</button>
                    </div>
                    <div id="gst-report-content" class="hidden space-y-3">
                        <h3 class="text-lg font-semibold">Report for <span id="report-period"></span></h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                            <div class="bg-gray-100 p-3 rounded-md">
                                <p class="text-sm text-gray-600">Total Taxable Value</p>
                                <p id="report-taxable-value" class="font-bold text-lg">‚Çπ0.00</p>
                            </div>
                            <div class="bg-gray-100 p-3 rounded-md">
                                <p class="text-sm text-gray-600">Total CGST</p>
                                <p id="report-total-cgst" class="font-bold text-lg">‚Çπ0.00</p>
                            </div>
                            <div class="bg-gray-100 p-3 rounded-md">
                                <p class="text-sm text-gray-600">Total SGST</p>
                                <p id="report-total-sgst" class="font-bold text-lg">‚Çπ0.00</p>
                            </div>
                            <div class="bg-gray-100 p-3 rounded-md">
                                <p class="text-sm text-gray-600">Total IGST</p>
                                <p id="report-total-igst" class="font-bold text-lg">‚Çπ0.00</p>
                            </div>
                            <div class="bg-gray-100 p-3 rounded-md">
                                <p class="text-sm text-gray-600">Total Cess</p>
                                <p id="report-total-cess" class="font-bold text-lg">‚Çπ0.00</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Documents &amp; Data Export</h2>
                    <div class="flex flex-wrap gap-4 mb-6">
                        <button id="export-tally" class="btn-primary">Export for Tally (XML)</button>
                        <button id="export-zoho" class="btn-primary">Export for Zoho (CSV)</button>
                        <button id="export-excel" class="btn-primary">Export as Excel</button>
                        <button id="export-json" class="btn-primary">Export as JSON</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr><th class="p-2">Doc No.</th><th class="p-2">Date</th><th class="p-2">Customer</th><th class="p-2">Amount</th><th class="p-2">Type</th><th class="p-2">Status</th><th class="p-2">Actions</th></tr>
                            </thead>
                            <tbody id="invoices-table"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="client-portal" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <!-- Client Portal Content will be dynamically generated here -->
    </div>

    <div id="help-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">GST Invoicing Guide</h2>
            <p class="mb-6 text-gray-600">This tool helps you create GST-compliant invoices. Here are some key concepts:</p>
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold text-lg">B2B vs B2C Invoices</h3>
                    <p class="text-sm text-gray-600 mb-2">The rules for B2B (to a registered business) and B2C (to a consumer) invoices are different, especially for reporting and ITC eligibility.</p>
                    <div class="chart-container !h-[300px]"><canvas id="b2b-b2c-chart"></canvas></div>
                </div>
            </div>
            <button id="close-help-modal" class="btn-secondary mt-8 w-full">Close</button>
        </div>
    </div>
    <div id="ai-suggest-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">‚ú® AI Item Suggester</h2>
            <p class="mb-4 text-gray-600">Describe the product or service you're selling. The AI will suggest a detailed description, HSN/SAC code, rate, and GST slab.</p>
            <div class="flex space-x-2">
                <input type="text" id="ai-item-prompt" class="input-field" placeholder="e.g., 'parle-g biscuits' or 'legal advice'">
                <button id="get-ai-suggestions-btn" class="btn-ai">Get Suggestions</button>
            </div>
            <div id="ai-suggestions-loader" class="hidden mt-6 flex justify-center"><div class="loader"></div></div>
            <div id="ai-suggestions-container" class="mt-6 space-y-2"></div>
            <button id="close-ai-suggest-modal" class="btn-secondary mt-8 w-full">Cancel</button>
        </div>
    </div>
    <div id="email-draft-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">‚ú® AI Email Draft</h2>
            <p class="mb-4 text-gray-600">Here's a professional email draft to send with your document. You can copy it to your clipboard.</p>
            <div id="email-draft-loader" class="hidden my-6 flex justify-center"><div class="loader"></div></div>
            <div id="email-draft-content">
                <textarea id="email-draft-textarea" rows="10" class="input-field w-full bg-gray-50" readonly></textarea>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="copy-email-btn" class="btn-primary">Copy to Clipboard</button>
                    <button id="close-email-draft-modal" class="btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div id="record-payment-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Record Payment</h2>
            <form id="record-payment-form">
                <input type="hidden" id="payment-invoice-id">
                <p class="mb-4">For Document: <strong id="payment-invoice-no"></strong></p>
                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                    <div>Total Amount: <strong id="payment-total-amount" class="block text-base"></strong></div>
                    <div class="text-right">Amount Due: <strong id="payment-amount-due" class="block text-base text-red-600"></strong></div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="payment-date" class="block text-sm font-medium text-gray-700">Payment Date</label>
                        <input type="date" id="payment-date" class="input-field mt-1" required>
                    </div>
                    <div>
                        <label for="payment-amount" class="block text-sm font-medium text-gray-700">Amount Received</label>
                        <input type="number" id="payment-amount" class="input-field mt-1" step="0.01" min="0.01" required>
                    </div>
                     <div>
                        <label for="payment-notes" class="block text-sm font-medium text-gray-700">Notes (Optional)</label>
                        <input type="text" id="payment-notes" class="input-field mt-1" placeholder="e.g., Bank Transfer Ref #123">
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-8">
                    <button type="button" id="cancel-payment-btn" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Payment</button>
                </div>
            </form>
        </div>
    </div>
    <div id="make-recurring-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Make Invoice Recurring</h2>
            <form id="make-recurring-form">
                <input type="hidden" id="recurring-invoice-id">
                <p class="mb-4">For Document: <strong id="recurring-invoice-no"></strong></p>
                <div class="space-y-4">
                    <div>
                        <label for="recurring-frequency" class="block text-sm font-medium text-gray-700">Frequency</label>
                        <select id="recurring-frequency" class="input-field mt-1">
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="annually">Annually</option>
                        </select>
                    </div>
                    <div>
                        <label for="recurring-next-date" class="block text-sm font-medium text-gray-700">Next Generation Date</label>
                        <input type="date" id="recurring-next-date" class="input-field mt-1" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-8">
                    <button type="button" id="cancel-recurring-btn" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Schedule</button>
                </div>
            </form>
        </div>
    </div>
    <div id="expense-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="expense-modal-title" class="text-2xl font-bold mb-4">Add Expense</h2>
            <form id="expense-form">
                <input type="hidden" id="expense-id">
                <div class="space-y-4">
                    <div>
                        <label for="expense-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="expense-date" class="input-field mt-1" required>
                    </div>
                    <div>
                        <label for="expense-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="expense-category" class="input-field mt-1">
                            <option>Software</option>
                            <option>Marketing</option>
                            <option>Utilities</option>
                            <option>Office Supplies</option>
                            <option>Travel</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="expense-description" class="block text-sm font-medium text-gray-700">Description</label>
                        <input type="text" id="expense-description" class="input-field mt-1" required>
                    </div>
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-gray-700">Amount</label>
                        <input type="number" id="expense-amount" class="input-field mt-1" step="0.01" min="0.01" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-8">
                    <button type="button" id="cancel-expense-btn" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Expense</button>
                </div>
            </form>
        </div>
    </div>
    <div id="add-product-modal" class="modal-backdrop hidden"></div>
    <div id="edit-product-modal" class="modal-backdrop hidden"></div>
    <div id="add-customer-modal" class="modal-backdrop hidden"></div>
    <div id="edit-customer-modal" class="modal-backdrop hidden"></div>
     <div id="import-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="import-title" class="text-2xl font-bold mb-4">Import Data</h2>
            <p class="text-sm text-gray-600 mb-2">Select an Excel file (.xlsx, .xls) to import. The first sheet will be used. This will <strong class="text-red-600">replace</strong> all existing master data for this category.</p>
            <div id="import-instructions" class="text-xs text-gray-500 bg-gray-50 p-2 rounded-md mb-4"></div>
            <input type="file" id="import-file-input" class="input-field" accept=".xlsx, .xls">
            <div class="flex justify-end space-x-2 mt-6">
                <button type="button" id="cancel-import" class="btn-secondary">Cancel</button>
                <button type="button" id="confirm-import-btn" class="btn-primary">Import Data</button>
            </div>
        </div>
    </div>
    <div id="confirm-delete-modal" class="modal-backdrop hidden">
        <div class="modal-content text-center">
            <h3 class="text-lg font-bold text-gray-900">Are you sure?</h3>
            <p id="confirm-message" class="text-sm text-gray-500 my-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="btn-secondary">Cancel</button>
                <button id="confirm-delete-btn" class="btn-danger">Delete</button>
            </div>
        </div>
    </div>
    <div id="toast-notification" class="toast opacity-0 -translate-y-20"></div>

    <div id="gst-rate-helper-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-3xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">GST Rate Helper (Effective Sept 22, 2025)</h2>
                <button id="close-gst-rate-helper-modal" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <div>
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button class="gst-helper-tab-btn active" data-tab="summary">Summary</button>
                        <button class="gst-helper-tab-btn" data-tab="finder">Rate Finder</button>
                        <button class="gst-helper-tab-btn" data-tab="rules">Transitional Rules</button>
                    </nav>
                </div>

                <div id="summary-tab-content" class="gst-helper-tab-content py-4">
                    <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg mb-4">
                        <p class="font-bold">Key Change Overview</p>
                        <p class="text-sm">The GST council has rationalized rates into a simpler structure: a **5% Merit Rate**, an **18% Standard Rate**, and a special 40% rate for select items. Most day-to-day items have seen a significant reduction.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="space-y-3">
                            <h3 class="font-semibold text-lg border-b pb-1">For the Common Person</h3>
                            <ul class="list-disc list-inside space-y-1">
                                <li><span class="font-semibold">NIL GST:</span> UHT Milk, Packaged Paneer, All Indian Breads (Roti, Paratha, etc.).</li>
                                <li><span class="font-semibold">Reduced to 5%:</span> Hair oil, toilet soap, shampoo, toothpaste, kitchenware, bicycles.</li>
                                <li><span class="font-semibold">Reduced to 18%:</span> Air Conditioners, all TVs, Dishwashers.</li>
                            </ul>
                        </div>
                        <div class="space-y-3">
                            <h3 class="font-semibold text-lg border-b pb-1">Food Items</h3>
                             <ul class="list-disc list-inside space-y-1">
                                <li><span class="font-semibold">Reduced to 5%:</span> Packaged namkeens/bhujia, sauces, pasta, noodles, chocolates, coffee, butter, ghee.</li>
                            </ul>
                        </div>
                        <div class="space-y-3">
                            <h3 class="font-semibold text-lg border-b pb-1">Health & Wellness</h3>
                             <ul class="list-disc list-inside space-y-1">
                                <li><span class="font-semibold">Exempted:</span> All individual Life & Health Insurance policies.</li>
                                <li><span class="font-semibold">NIL GST:</span> 36 specified lifesaving drugs.</li>
                                <li><span class="font-semibold">Reduced to 5%:</span> All other medicines, most medical devices, and diagnostic kits.</li>
                            </ul>
                        </div>
                        <div class="space-y-3">
                            <h3 class="font-semibold text-lg border-b pb-1">Automobiles</h3>
                             <ul class="list-disc list-inside space-y-1">
                                <li><span class="font-semibold">Reduced to 18%:</span> Small cars, Motorcycles (‚â§350cc), Buses, Trucks, Ambulances, 3-Wheelers.</li>
                                <li><span class="font-semibold">Reduced to 18%:</span> Cement.</li>
                            </ul>
                        </div>
                         <div class="space-y-3 md:col-span-2">
                            <h3 class="font-semibold text-lg border-b pb-1">Services</h3>
                             <ul class="list-disc list-inside space-y-1">
                                <li><span class="font-semibold">Reduced to 5%:</span> Hotel stays (up to ‚Çπ7,500/day), Gyms, Salons, Barbers, Yoga centers.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="finder-tab-content" class="gst-helper-tab-content py-4 hidden">
                    <p class="text-sm text-gray-600 mb-4">Search for a product or service to find its new GST rate effective from Sept 22, 2025. For example: "cement", "soap", "hotel".</p>
                    <input type="text" id="rate-finder-search" class="input-field mb-4" placeholder="Type to search...">
                    <div id="rate-finder-results" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        <!-- Search results will be populated here -->
                    </div>
                </div>

                <div id="rules-tab-content" class="gst-helper-tab-content py-4 hidden">
                    <h3 class="font-semibold text-lg mb-2">Invoicing Around the Sept 22, 2025 Cut-off</h3>
                    <p class="text-sm text-gray-600 mb-4">When a supply is made before the rate change but the invoice is issued after, the correct GST rate depends on when the payment was received. Here‚Äôs a simple guide based on official rules (Sec 14 of CGST Act).</p>
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800">Scenario 1: Supply Made <span class="text-red-600">BEFORE</span> Sept 22, Payment Received <span class="text-green-600">AFTER</span> Sept 22</h4>
                            <p class="text-sm mt-1">If both the invoice and the payment happen after the rate change...</p>
                            <p class="text-lg font-bold text-green-700 mt-2">‚úÖ Use the NEW GST Rate.</p>
                            <p class="text-xs text-gray-500 mt-1"><strong>Example:</strong> You delivered goods on Sept 20th. You issue the invoice on Sept 25th and receive payment on Oct 1st. The new GST rate applies.</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800">Scenario 2: Supply Made <span class="text-red-600">BEFORE</span> Sept 22, Payment Received <span class="text-red-600">BEFORE</span> Sept 22</h4>
                            <p class="text-sm mt-1">If you received payment (even partial) before the rate change...</p>
                            <p class="text-lg font-bold text-red-700 mt-2">‚úÖ Use the OLD GST Rate.</p>
                            <p class="text-xs text-gray-500 mt-1"><strong>Example:</strong> You received an advance payment on Sept 15th for goods you delivered on Sept 20th. Even if you invoice on Sept 25th, the old GST rate applies to the amount paid.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .gst-helper-tab-btn {
            @apply border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 text-sm font-medium;
        }
        .gst-helper-tab-btn.active {
            @apply border-slate-700 text-slate-700;
        }
    </style>
    
    <script>
        // App Loader
        const appLoader = document.getElementById('app-loader');
        const mainApp = document.getElementById('app');
        
        // App Entry Point - Converted to Offline
        document.addEventListener('DOMContentLoaded', () => {
            runOfflineApp();
        });

        // Main Offline App Function
        function runOfflineApp() {

            const LOCAL_STORAGE_KEY = 'gstInvoiceGeneratorData';

            const SELECTORS = {
                mainNav: '#main-nav',
                documentType: '#document-type',
                transactionType: '#transaction-type',
                reasonForTransport: '#reason-for-transport',
                reverseCharge: '#reverse-charge',
                invoiceFormContainer: '#invoice-form-container',
                originalDocContainer: '#original-doc-details-container',
                supplierName: '#supplier-name',
                supplierGstin: '#supplier-gstin',
                supplierAddress: '#supplier-address',
                supplierPincode: '#supplier-pincode',
                recipientName: '#recipient-name',
                recipientGstinContainer: '#recipient-gstin-container',
                recipientGstin: '#recipient-gstin',
                recipientAddress: '#recipient-address',
                recipientPincode: '#recipient-pincode',
                sameAsBilling: '#same-as-billing',
                b2cDetailsToggleContainer: '#b2c-details-toggle-container',
                addRecipientDetails: '#add-recipient-details',
                deliveryAddressContainer: '#delivery-address-container',
                deliveryAddress: '#delivery-address',
                placeOfSupply: '#place-of-supply',
                invoiceNo: '#invoice-no',
                invoiceDate: '#invoice-date',
                invoiceNoLabel: 'label[for="invoice-no"]',
                invoiceDateLabel: 'label[for="invoice-date"]',
                originalInvoiceNo: '#original-invoice-no',
                originalInvoiceDate: '#original-invoice-date',
                invoiceItemsHead: '#invoice-items-head',
                invoiceItemsBody: '#invoice-items',
                addItemBtn: '#add-item-btn',
                ewayBillDetailsCard: '#eway-bill-details-card',
                ewayBillReminder: '#eway-bill-reminder',
                taxSummaryContainer: '#tax-summary-container',
                summarySubtotal: '#summary-subtotal',
                summaryCgst: '#summary-cgst',
                summarySgst: '#summary-sgst',
                summaryIgst: '#summary-igst',
                summaryCess: '#summary-cess',
                summaryRoundoff: '#summary-roundoff',
                summaryTotal: '#summary-total',
                actionButtons: '#action-buttons',
                newInvoiceBtn: '#new-invoice-btn',
                saveDraftBtn: '#save-draft-btn',
                generatePdfBtn: '#generate-pdf-btn',
                generateEwayJsonBtn: '#generate-eway-json-btn',
                profileListManage: '#profile-list-manage',
                addProfileForm: '#add-profile-form-manage',
                newProfileNameInput: '#new-profile-name-manage',
                productsTable: '#products-table',
                customersTable: '#customers-table',
                recurringTable: '#recurring-table',
                expensesTable: '#expenses-table',
                addProductBtn: '#add-product-btn',
                addCustomerBtn: '#add-customer-btn',
                addExpenseBtn: '#add-expense-btn',
                invoicesTable: '#invoices-table',
                toast: '#toast-notification',
                clientSelector: '#client-selector',
                customerDatalist: '#customer-datalist',
                productDatalist: '#product-datalist',
                importProductsBtn: '#import-products-btn',
                importCustomersBtn: '#import-customers-btn',
                transMode: '#trans-mode',
                vehicleNoContainer: '#vehicle-no-container',
                transDocContainer: '#trans-doc-container',
                reportsSection: '#reports',
                manageDataSection: '#manage-data',
                backupDataBtn: '#backup-data-btn',
                restoreDataBtn: '#restore-data-btn',
                isServiceInvoice: '#is-service-invoice',
            };

            const NO_TAX_DOC_TYPES = [
                'bill_of_supply', 
                'delivery_challan', 
                'financial_debit_note', 
                'financial_credit_note'
            ];

            const getInitialProfileData = () => ({
                products: [],
                customers: [],
                invoices: [],
                recurring: [],
                expenses: [],
                dailySales: {},
                settings: {
                    paymentTerms: 'Payment due within 30 days.',
                    bankDetails: 'Bank: XYZ Bank, A/C: 1234567890, IFSC: XYZB0001234',
                    invoicePrefix: 'INV/',
                    lastInvoiceNumber: 0,
                    logo: null,
                    signatoryImage: null,
                    businessType: 'General',
                    isCompositionScheme: false,
                    geminiApiKey: ''
                }
            });

            const getInitialInvoiceState = () => ({
                id: null, // Each invoice will have a unique ID
                details: {
                    docType: 'tax_invoice',
                    transactionType: 'b2b',
                    reverseCharge: false,
                    supplierName: 'Your Company Name',
                    supplierGstin: '27ABCDE1234F1Z5',
                    supplierAddress: '123 Business Lane, Mumbai, Maharashtra',
                    supplierPincode: '',
                    recipientName: '',
                    recipientGstin: '',
                    recipientAddress: '',
                    recipientPincode: '',
                    deliveryAddress: '',
                    placeOfSupply: '',
                    unregisteredSupplierName: '',
                    unregisteredSupplierAddress: '',
                    invoiceNo: '',
                    invoiceDate: new Date().toISOString().slice(0, 10),
                    originalInvoiceNo: '',
                    originalInvoiceDate: '',
                    gtaConsignorName: '',
                    gtaConsigneeName: '',
                    gtaVehicleNo: '',
                    gtaGrossWeight: '',
                    gtaPlaceOfOrigin: '',
                    gtaPlaceOfDestination: '',
                    transporterName: '',
                    transporterId: '',
                    transMode: '1',
                    reasonForTransport: '1',
                    vehicleNo: '',
                    transDocNo: '',
                    transDocDate: '',
                    approxDistance: '',
                    packagingHandlingCharges: 0,
                    packagingHandlingChargesSac: '',
                    deliveryCharges: 0,
                    deliveryChargesSac: '',
                    cashHandlingCharges: 0,
                    cashHandlingChargesSac: '',
                    rewardsUsed: 0,
                    isConsolidated: false,
                    isServiceInvoice: false,
                    total: 0,
                    docTypeLabel: 'Tax Invoice',
                    invoiceCopyType: 'Original for Recipient',
                    irn: '',
                    ewayBillNo: ''
                },
                items: [{ name: '', hsn: '', qty: 1, unit: 'PCS', rate: 0, discount: 0, gst: 18, cess: 0 }],
                status: 'Draft',
                payments: []
            });

            let appState = {
                profiles: [],
                activeProfileId: null,
                profileData: {},
                indianStates: { 'Andhra Pradesh':'37', 'Arunachal Pradesh':'12', 'Assam':'18', 'Bihar':'10', 'Chhattisgarh':'22', 'Goa':'30', 'Gujarat':'24', 'Haryana':'06', 'Himachal Pradesh':'02', 'Jharkhand':'20', 'Karnataka':'29', 'Kerala':'32', 'Madhya Pradesh':'23', 'Maharashtra':'27', 'Manipur':'14', 'Meghalaya':'17', 'Mizoram':'15', 'Nagaland':'13', 'Odisha':'21', 'Punjab':'03', 'Rajasthan':'08', 'Sikkim':'11', 'Tamil Nadu':'33', 'Telangana':'36', 'Tripura':'16', 'Uttar Pradesh':'09', 'Uttarakhand':'05', 'West Bengal':'19', 'Andaman and Nicobar Islands':'35', 'Chandigarh':'04', 'Dadra and Nagar Haveli and Daman and Diu':'26', 'Delhi':'07', 'Jammu and Kashmir':'01', 'Ladakh':'38', 'Lakshadweep':'31', 'Puducherry':'34' },
                currentInvoice: getInitialInvoiceState()
            };
            
            let b2bChartInstance = null;
            let statusChartInstance = null;
            let customerChartInstance = null;

            // --- LocalStorage Data Management ---
            function loadDataFromLocalStorage() {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (data) {
                    appState = JSON.parse(data);
                } else {
                    // First time user, create a default profile
                    const newId = String(Date.now());
                    appState.profiles = [{ id: newId, name: "My Business" }];
                    appState.profileData[newId] = getInitialProfileData();
                    appState.activeProfileId = newId;
                    saveDataToLocalStorage();
                }
            }
            
            function saveDataToLocalStorage() {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appState));
            }

            function getActiveProfileData() {
                return appState.profileData[appState.activeProfileId] || getInitialProfileData();
            }

            function resetInvoiceState() {
                appState.currentInvoice = getInitialInvoiceState();
                appState.currentInvoice.id = String(Date.now()); // Assign a new unique ID
                autoFillInvoiceNumber();
            }

            function showToast(message, isError = false) {
                const toast = document.querySelector(SELECTORS.toast);
                toast.textContent = message;
                toast.className = `toast ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                toast.classList.remove('opacity-0', '-translate-y-20');
                setTimeout(() => {
                    toast.classList.add('opacity-0', '-translate-y-20');
                }, 3000);
            }

            function fallbackCopyTextToClipboard(text) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.top = "0";
                textArea.style.left = "0";
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('Copied to clipboard!');
                } catch (err) {
                    showToast('Could not copy text.', true);
                }
                document.body.removeChild(textArea);
            }

            function copyTextToClipboard(text) {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        showToast('Copied to clipboard!');
                    }, () => {
                        fallbackCopyTextToClipboard(text);
                    });
                } else {
                    fallbackCopyTextToClipboard(text);
                }
            }

            function safeParseFloat(value) {
                const parsed = parseFloat(value);
                return isNaN(parsed) ? 0 : parsed;
            }
            
            function isInterState(supplierGstin, placeOfSupply) {
                if(!supplierGstin || !placeOfSupply) return false;
                const supplierStateCode = supplierGstin.substring(0, 2);
                const posStateCode = appState.indianStates[placeOfSupply];
                return supplierStateCode && posStateCode && supplierStateCode !== posStateCode;
            }

            function calculateTotals(invoice) {
                let subtotal = 0, cgst = 0, sgst = 0, igst = 0, cess = 0;
                const { details, items } = invoice;
                const interStateCheck = isInterState(details.supplierGstin, details.placeOfSupply);
                const docType = details.docType;

                items.forEach(item => {
                    const totalValue = safeParseFloat(item.qty) * safeParseFloat(item.rate);
                    const taxableValue = totalValue - safeParseFloat(item.discount);
                    subtotal += taxableValue;

                    if (!NO_TAX_DOC_TYPES.includes(docType)) {
                        const taxAmount = (taxableValue * safeParseFloat(item.gst)) / 100;
                        cess += (taxableValue * safeParseFloat(item.cess)) / 100;
                        if (interStateCheck) {
                            igst += taxAmount;
                        } else {
                            cgst += taxAmount / 2;
                            sgst += taxAmount / 2;
                        }
                    }
                });
                
                const additionalCharges = safeParseFloat(details.packagingHandlingCharges) +
                                          safeParseFloat(details.deliveryCharges) +
                                          safeParseFloat(details.cashHandlingCharges);

                if (additionalCharges > 0 && !NO_TAX_DOC_TYPES.includes(docType)) {
                    const highestGstRate = items.length > 0 ? Math.max(...items.map(item => safeParseFloat(item.gst))) : 0;
                    if (highestGstRate > 0) {
                        const taxOnCharges = (additionalCharges * highestGstRate) / 100;
                        if (interStateCheck) {
                            igst += taxOnCharges;
                        } else {
                            cgst += taxOnCharges / 2;
                            sgst += taxOnCharges / 2;
                        }
                    }
                }
                
                const totalBeforeRewards = subtotal + additionalCharges + cgst + sgst + igst + cess;
                const rewardsUsed = safeParseFloat(details.rewardsUsed);
                const totalAfterRewards = totalBeforeRewards - rewardsUsed;
                
                const grandTotal = Math.round(totalAfterRewards);
                const roundOff = grandTotal - totalAfterRewards;

                return { subtotal, additionalCharges, cgst, sgst, igst, cess, roundOff, totalBeforeRewards, rewardsUsed, grandTotal };
            }

            function updateSummarySection() {
                const totals = calculateTotals(appState.currentInvoice);
                const details = appState.currentInvoice.details;
                
                document.querySelector(SELECTORS.summarySubtotal).textContent = `‚Çπ${totals.subtotal.toFixed(2)}`;

                const packagingCharge = safeParseFloat(details.packagingHandlingCharges);
                const deliveryCharge = safeParseFloat(details.deliveryCharges);
                const cashHandlingCharge = safeParseFloat(details.cashHandlingCharges);

                const packagingEl = document.getElementById('summary-packaging-handling');
                if (packagingEl) {
                    packagingEl.textContent = `‚Çπ${packagingCharge.toFixed(2)}`;
                    packagingEl.parentElement.style.display = packagingCharge > 0 ? 'flex' : 'none';
                }
 
                document.querySelector(SELECTORS.summaryTotal).textContent = `‚Çπ${totals.grandTotal.toFixed(2)}`;
                document.querySelector(SELECTORS.ewayBillReminder).classList.toggle('hidden', totals.grandTotal <= 50000 || appState.currentInvoice.details.isServiceInvoice);
            }
 
            function validateCreditNoteDeadline() {
                const warningDiv = document.getElementById('credit-note-warning');
                const docType = appState.currentInvoice.details.docType;
                const originalDateValue = appState.currentInvoice.details.originalInvoiceDate;

                if (docType !== 'credit_note' || !originalDateValue) {
                    warningDiv.classList.add('hidden');
                    return;
                }

                const originalDate = new Date(originalDateValue);
                if (isNaN(originalDate.getTime())) {
                    warningDiv.classList.add('hidden');
                    return;
                }
                
                const month = originalDate.getMonth();
                const year = originalDate.getFullYear();
                const financialYearEndYear = (month >= 3) ? year + 1 : year;
                const deadline = new Date(financialYearEndYear, 10, 30);
                const today = new Date();

                if (today > deadline) {
                    warningDiv.classList.remove('hidden');
                } else {
                    warningDiv.classList.add('hidden');
                }
            }

            function render() {
                const { details, items } = appState.currentInvoice;
                
                for (const key in details) {
                    if (key === 'invoiceCopyType') continue;
                    const el = document.getElementById(key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`));
                    if (el) {
                        if (el.type === 'checkbox') {
                            el.checked = details[key];
                        } else {
                            if (el.value !== details[key]) {
                                el.value = details[key];
                            }
                        }
                    }
                }
                
                const invoiceCopyTypeEl = document.getElementById('invoice-copy-type');
                if (document.activeElement !== invoiceCopyTypeEl) {
                    invoiceCopyTypeEl.value = details.invoiceCopyType || 'Original for Recipient';
                }

                updateFormUIFromState();
                renderInvoiceItemsFromState(items);
                updateSummarySection();
                validateForm();
            }

            function updateCalculations() {
                const itemRows = document.querySelectorAll('#invoice-items tr');
                const docType = appState.currentInvoice.details.docType;
                const showTaxColumns = !NO_TAX_DOC_TYPES.includes(docType);

                appState.currentInvoice.items.forEach((item, index) => {
                    const row = itemRows[index];
                    if (!row) return;
                    const taxableValue = (safeParseFloat(item.qty) * safeParseFloat(item.rate)) - safeParseFloat(item.discount);
                    let itemTotal = taxableValue;
                    if (showTaxColumns) {
                        itemTotal += (taxableValue * (safeParseFloat(item.gst) + safeParseFloat(item.cess))) / 100;
                    }
                    
                    const taxableEl = row.querySelector('.item-taxable');
                    if (taxableEl) taxableEl.textContent = `‚Çπ${taxableValue.toFixed(2)}`;
                    
                    const totalEl = row.querySelector('.item-total');
                    if (totalEl) totalEl.textContent = `‚Çπ${itemTotal.toFixed(2)}`;
                });

                updateSummarySection();
                updateFormUIFromState();
                validateForm();
            }

            function updateDocumentLabels(docType) {
                const invoiceNoLabel = document.querySelector(SELECTORS.invoiceNoLabel);
                const invoiceDateLabel = document.querySelector(SELECTORS.invoiceDateLabel);
                let noLabel = 'Document No.';
                let dateLabel = 'Document Date';

                switch (docType) {
                    case 'purchase_order': noLabel = 'PO No.'; dateLabel = 'PO Date'; break;
                    case 'sales_order': noLabel = 'SO No.'; dateLabel = 'SO Date'; break;
                    case 'proforma_invoice': noLabel = 'Proforma No.'; dateLabel = 'Proforma Date'; break;
                    case 'tax_invoice': noLabel = 'Invoice No.'; dateLabel = 'Invoice Date'; break;
                    case 'bill_of_supply': noLabel = 'Bill of Supply No.'; dateLabel = 'Date'; break;
                    case 'debit_note': case 'financial_debit_note': noLabel = 'Debit Note No.'; dateLabel = 'Debit Note Date'; break;
                    case 'credit_note': case 'financial_credit_note': noLabel = 'Credit Note No.'; dateLabel = 'Credit Note Date'; break;
                    case 'payment_voucher': noLabel = 'Payment Voucher No.'; dateLabel = 'Payment Date'; break;
                    case 'receipt_voucher': noLabel = 'Receipt Voucher No.'; dateLabel = 'Receipt Date'; break;
                    case 'refund_voucher': noLabel = 'Refund Voucher No.'; dateLabel = 'Refund Date'; break;
                    case 'delivery_challan': noLabel = 'Challan No.'; dateLabel = 'Challan Date'; break;
                    case 'self_invoice_rcm': noLabel = 'Self-Invoice No.'; dateLabel = 'Self-Invoice Date'; break;
                }
                invoiceNoLabel.textContent = noLabel;
                invoiceDateLabel.textContent = dateLabel;
            }

            function updateDocumentTypeOptions() {
                const transactionType = appState.currentInvoice.details.transactionType;
                const docTypeSelect = document.querySelector(SELECTORS.documentType);
                
                const optionValue = 'invoice_cum_bill_of_supply';
                const optionText = 'Invoice cum Bill of Supply';
                let existingOption = docTypeSelect.querySelector(`option[value="${optionValue}"]`);

                if (transactionType === 'b2c') {
                    if (!existingOption) {
                        const newOption = new Option(optionText, optionValue);
                        const billOfSupplyOption = docTypeSelect.querySelector('option[value="bill_of_supply"]');
                        if (billOfSupplyOption) {
                            billOfSupplyOption.insertAdjacentElement('afterend', newOption);
                        } else {
                            docTypeSelect.appendChild(newOption);
                        }
                    }
                } else { // b2b
                    if (existingOption) {
                        if (appState.currentInvoice.details.docType === optionValue) {
                            appState.currentInvoice.details.docType = 'tax_invoice';
                        }
                        existingOption.remove();
                    }
                }
            }

            function updateFormUIFromState() {
                const { docType, transactionType, transMode, isServiceInvoice } = appState.currentInvoice.details;
                const taxableValue = calculateTotals(appState.currentInvoice).subtotal;
 
                document.querySelector(SELECTORS.originalDocContainer).classList.toggle('hidden', !['debit_note', 'credit_note', 'refund_voucher'].includes(docType));

                const invoiceFormContainer = document.getElementById('invoice-form-container');
                const voucherFormContainer = document.getElementById('voucher-form-container');
                const voucherTitle = document.getElementById('voucher-title');
                const receiptVoucherFields = document.getElementById('receipt-voucher-fields');
                const refundVoucherFields = document.getElementById('refund-voucher-fields');
                const paymentVoucherFields = document.getElementById('payment-voucher-fields');
                const isVoucher = ['payment_voucher', 'receipt_voucher', 'refund_voucher'].includes(docType);

                invoiceFormContainer.classList.toggle('hidden', isVoucher);
                voucherFormContainer.classList.toggle('hidden', !isVoucher);
                receiptVoucherFields.classList.add('hidden');
                refundVoucherFields.classList.add('hidden');
                paymentVoucherFields.classList.add('hidden');

                if (isVoucher) {
                    if (docType === 'payment_voucher') { voucherTitle.textContent = 'Payment Voucher Details'; paymentVoucherFields.classList.remove('hidden'); } 
                    else if (docType === 'receipt_voucher') { voucherTitle.textContent = 'Receipt Voucher Details'; receiptVoucherFields.classList.remove('hidden'); } 
                    else if (docType === 'refund_voucher') { voucherTitle.textContent = 'Refund Voucher Details'; refundVoucherFields.classList.remove('hidden'); }
                }

                const supplierHeader = document.getElementById('supplier-details-header');
                const recipientHeader = document.querySelector('#recipient-details-container h3');
                const recipientContainer = document.getElementById('recipient-details-container');
                const unregisteredSupplierContainer = document.getElementById('unregistered-supplier-details-container');
                const reverseChargeCheckbox = document.getElementById('reverse-charge');

                supplierHeader.textContent = 'Supplier Details (You)';
                if (recipientHeader) recipientHeader.textContent = 'Recipient Details (Client)';
                recipientContainer.classList.remove('hidden');
                unregisteredSupplierContainer.classList.add('hidden');
                reverseChargeCheckbox.disabled = false;
                
                if (docType === 'self_invoice_rcm') {
                    supplierHeader.textContent = 'Recipient Details (You)';
                    recipientContainer.classList.add('hidden');
                    unregisteredSupplierContainer.classList.remove('hidden');
                    reverseChargeCheckbox.checked = true;
                    reverseChargeCheckbox.disabled = true;
                    appState.currentInvoice.details.reverseCharge = true;
                } else if (docType === 'purchase_order') {
                    supplierHeader.textContent = 'Buyer Details (You)';
                    if (recipientHeader) recipientHeader.textContent = 'Seller Details';
                } else if (appState.currentInvoice.details.reverseCharge && reverseChargeCheckbox.disabled) {
                    reverseChargeCheckbox.checked = false;
                    appState.currentInvoice.details.reverseCharge = false;
                }

                document.querySelector(SELECTORS.taxSummaryContainer).classList.toggle('hidden', NO_TAX_DOC_TYPES.includes(docType));
                validateCreditNoteDeadline();
                
                const recipientGstinContainer = document.querySelector(SELECTORS.recipientGstinContainer);
                const b2cToggleContainer = document.querySelector(SELECTORS.b2cDetailsToggleContainer);
                const addRecipientDetailsCheckbox = document.querySelector(SELECTORS.addRecipientDetails);
                const recipientName = document.querySelector(SELECTORS.recipientName);
                const recipientAddress = document.querySelector(SELECTORS.recipientAddress);

                if (transactionType === 'b2b') {
                    recipientGstinContainer.style.display = 'block';
                    b2cToggleContainer.classList.add('hidden');
                    recipientName.required = true;
                    recipientAddress.required = true;
                } else { // b2c
                    recipientGstinContainer.style.display = 'none';
                    b2cToggleContainer.classList.remove('hidden');
                    const detailsRequired = taxableValue >= 50000;
                    if (detailsRequired) {
                        addRecipientDetailsCheckbox.checked = true;
                        addRecipientDetailsCheckbox.disabled = true;
                        b2cToggleContainer.querySelector('span').textContent = 'Recipient details (required for B2C >= ‚Çπ50k)';
                        recipientName.required = true;
                        recipientAddress.required = true;
                    } else {
                        addRecipientDetailsCheckbox.disabled = false;
                        b2cToggleContainer.querySelector('span').textContent = 'Add recipient details (optional for B2C < ‚Çπ50k)';
                        recipientName.required = addRecipientDetailsCheckbox.checked;
                        recipientAddress.required = addRecipientDetailsCheckbox.checked;
                    }
                }
                
                document.querySelector(SELECTORS.ewayBillDetailsCard).classList.toggle('hidden', !['tax_invoice', 'bill_of_supply', 'delivery_challan', 'sales_order'].includes(docType));
                
                const isRoad = transMode === '1';
                document.querySelector(SELECTORS.vehicleNoContainer).classList.toggle('hidden', !isRoad);
                document.querySelector(SELECTORS.transDocContainer).classList.toggle('hidden', isRoad);

                // Handle service invoice UI
                const sameAsBillingContainer = document.querySelector(SELECTORS.sameAsBilling).parentElement;
                const deliveryAddressContainer = document.querySelector(SELECTORS.deliveryAddressContainer);

                if (isServiceInvoice) {
                    sameAsBillingContainer.classList.add('hidden');
                    deliveryAddressContainer.classList.add('hidden');
                    document.querySelector(SELECTORS.ewayBillDetailsCard).classList.add('hidden');
                } else {
                    sameAsBillingContainer.classList.remove('hidden');
                    deliveryAddressContainer.style.display = appState.currentInvoice.details.sameAsBilling ? 'none' : 'block';
                    document.querySelector(SELECTORS.ewayBillDetailsCard).classList.toggle('hidden', !['tax_invoice', 'bill_of_supply', 'delivery_challan', 'sales_order'].includes(docType));
                }
            }
 
            function updateSpecialFieldsUI() {
                const settings = getActiveProfileData().settings;
                const businessType = settings.businessType || 'General';
                const gtaContainer = document.getElementById('gta-details-container');
                gtaContainer.classList.add('hidden');

                if (businessType === 'Goods Transport Agency') {
                    gtaContainer.classList.remove('hidden');
                    if (!appState.currentInvoice.details.gtaConsignorName) appState.currentInvoice.details.gtaConsignorName = appState.currentInvoice.details.supplierName;
                    if (!appState.currentInvoice.details.gtaConsigneeName) appState.currentInvoice.details.gtaConsigneeName = appState.currentInvoice.details.recipientName;
                    document.getElementById('gta-consignor-name').value = appState.currentInvoice.details.gtaConsignorName;
                    document.getElementById('gta-consignee-name').value = appState.currentInvoice.details.gtaConsigneeName;
                    document.getElementById('gta-vehicle-no').value = appState.currentInvoice.details.gtaVehicleNo;
                    document.getElementById('gta-gross-weight').value = appState.currentInvoice.details.gtaGrossWeight;
                    document.getElementById('gta-place-of-origin').value = appState.currentInvoice.details.gtaPlaceOfOrigin;
                    document.getElementById('gta-place-of-destination').value = appState.currentInvoice.details.gtaPlaceOfDestination;
                }
            }

            function renderInvoiceItemsFromState(items) {
                const docType = appState.currentInvoice.details.docType;
                const isB2B = appState.currentInvoice.details.transactionType === 'b2b';
                const head = document.querySelector(SELECTORS.invoiceItemsHead);
                const tbody = document.querySelector(SELECTORS.invoiceItemsBody);
                
                let headHtml = '<tr><th class="p-2">Sr.</th><th class="p-2 w-1/4">Item</th><th class="p-2">HSN/SAC</th><th class="p-2">Qty</th><th class="p-2">Unit</th>';
                const showPriceAndTax = docType !== 'delivery_challan';
                const showTaxColumns = !NO_TAX_DOC_TYPES.includes(docType);

                if (showPriceAndTax) headHtml += '<th class="p-2">Rate</th><th class="p-2">Discount</th><th class="p-2">Taxable</th>';
                if (showTaxColumns) headHtml += '<th class="p-2">GST%</th><th class="p-2">Cess%</th>';
                if (showPriceAndTax) headHtml += '<th class="p-2">Total</th>';
                headHtml += '<th class="p-2"></th></tr>';
                head.innerHTML = headHtml;

                tbody.innerHTML = items.map((item, index) => {
                    const taxableValue = (safeParseFloat(item.qty) * safeParseFloat(item.rate)) - safeParseFloat(item.discount);
                    let itemTotal = taxableValue;
                    if (showTaxColumns) itemTotal += (taxableValue * (safeParseFloat(item.gst) + safeParseFloat(item.cess))) / 100;

                    let rowHtml = `<tr class="border-b">
                        <td class="p-2 text-center">${index + 1}</td>
                        <td class="p-2"><input type="text" class="input-field item-name" value="${item.name || ''}" data-index="${index}" list="product-datalist"></td>
                        <td class="p-2"><input type="text" class="input-field item-hsn" value="${item.hsn || ''}" data-index="${index}" ${isB2B ? 'required' : ''} placeholder="${isB2B ? 'HSN/SAC' : 'HSN (Optional)'}"></td>
                        <td class="p-2"><input type="number" class="input-field item-qty" value="${item.qty || 1}" data-index="${index}" min="0"></td>
                        <td class="p-2"><input type="text" class="input-field item-unit" value="${item.unit || ''}" data-index="${index}"></td>`;
                    
                    if (showPriceAndTax) {
                        rowHtml += `<td class="p-2"><input type="number" class="input-field item-rate" value="${(safeParseFloat(item.rate) || 0).toFixed(2)}" data-index="${index}" step="0.01" min="0"></td>
                                    <td class="p-2"><input type="number" class="input-field item-discount" value="${(safeParseFloat(item.discount) || 0).toFixed(2)}" data-index="${index}" step="0.01" min="0"></td>
                                    <td class="p-2 text-right item-taxable">‚Çπ${taxableValue.toFixed(2)}</td>`;
                    }
                    if (showTaxColumns) {
                        rowHtml += `<td class="p-2"><input type="number" class="input-field item-gst" value="${item.gst || 0}" data-index="${index}" step="0.1" min="0"></td>
                                    <td class="p-2"><input type="number" class="input-field item-cess" value="${item.cess || 0}" data-index="${index}" step="0.1" min="0"></td>`;
                    }
                     if (showPriceAndTax) rowHtml += `<td class="p-2 text-right item-total">‚Çπ${itemTotal.toFixed(2)}</td>`;
                    rowHtml += `<td class="p-2 text-center"><button class="text-red-500 hover:text-red-700 remove-item-btn text-xl font-bold" data-index="${index}">&times;</button></td></tr>`;
                    return rowHtml;
                }).join('');
            }
            
            document.getElementById('create-invoice').addEventListener('input', (e) => {
                const target = e.target;
                const camelCaseId = target.id.replace(/-(\w)/g, (_, letter) => letter.toUpperCase());
                let propertyToUpdate = camelCaseId;

                const isVoucher = ['payment_voucher', 'receipt_voucher', 'refund_voucher'].includes(appState.currentInvoice.details.docType);
                if (isVoucher) {
                    const voucherPropMap = { voucherNo: 'invoiceNo', voucherDate: 'invoiceDate', voucherDescription: 'voucherDescription', advanceAmount: 'advanceAmount', refundAmount: 'refundAmount', paymentAmountVoucher: 'paymentAmount', originalReceiptVoucherNo: 'originalReceiptVoucherNo' };
                    if (voucherPropMap[camelCaseId]) {
                         appState.currentInvoice.details[voucherPropMap[camelCaseId]] = target.type === 'number' ? safeParseFloat(target.value) : target.value;
                         return;
                    }
                }

                if (camelCaseId === 'documentType') propertyToUpdate = 'docType';
                if (camelCaseId === 'invoiceCopyType') propertyToUpdate = 'invoiceCopyType';

                if (appState.currentInvoice.details.hasOwnProperty(propertyToUpdate)) {
                    const value = target.type === 'checkbox' ? target.checked : target.value;
                    if (['packagingHandlingCharges', 'deliveryCharges', 'cashHandlingCharges', 'rewardsUsed'].includes(propertyToUpdate)) {
                        appState.currentInvoice.details[propertyToUpdate] = safeParseFloat(value);
                    } else {
                        appState.currentInvoice.details[propertyToUpdate] = value;
                    }

                    // NEW: Auto-fill customer details
                    if (propertyToUpdate === 'recipientName') {
                        const matchedCustomer = getActiveProfileData().customers.find(c => c.name === value);
                        if (matchedCustomer) {
                            appState.currentInvoice.details.recipientGstin = matchedCustomer.gstin || '';
                            appState.currentInvoice.details.recipientAddress = matchedCustomer.address || '';
                            appState.currentInvoice.details.recipientPincode = matchedCustomer.pincode || '';
                            appState.currentInvoice.details.placeOfSupply = matchedCustomer.state || '';
                            
                            const sameAsBillingCheckbox = document.querySelector(SELECTORS.sameAsBilling);
                            if (sameAsBillingCheckbox && sameAsBillingCheckbox.checked) {
                                appState.currentInvoice.details.deliveryAddress = matchedCustomer.address || '';
                            }
                        }
                    }
                    
                    if (['docType', 'transactionType', 'supplierGstin', 'placeOfSupply', 'reverseCharge', 'addRecipientDetails', 'recipientName', 'isServiceInvoice'].includes(propertyToUpdate)) { // Added recipientName & isServiceInvoice
                        render();
                    } else {
                        updateCalculations();
                    }
                } 
                else if (target.closest('#invoice-items')) {
                    const index = e.target.dataset.index;
                    if (index === undefined) return;
                    const item = appState.currentInvoice.items[index];
                    if (!item) return;
                    const property = e.target.className.match(/item-(\w+)/)[1];
                    const value = e.target.value;
                    if (e.target.type === 'number') {
                        item[property] = safeParseFloat(value);
                        updateCalculations();
                    } else {
                        item[property] = value;
                    }
                    if (property === 'name') {
                        const matchedProduct = getActiveProfileData().products.find(p => p.name === value);
                        if (matchedProduct) {
                            appState.currentInvoice.items[index] = { ...item, ...matchedProduct, qty: item.qty || 1 };
                            render();
                        }
                    }
                }
            });
            
            document.querySelector(SELECTORS.invoiceItemsBody).addEventListener('click', (e) => {
                if (e.target.closest('.remove-item-btn')) {
                    const index = e.target.closest('.remove-item-btn').dataset.index;
                    appState.currentInvoice.items.splice(index, 1);
                    render();
                }
            });

            document.getElementById('create-invoice').addEventListener('click', (e) => {
                const target = e.target.closest('.auto-fill-sac-btn');
                if (target) {
                    const sacCode = target.dataset.sac;
                    const sacInput = target.previousElementSibling;
                    if (sacInput) {
                        sacInput.value = sacCode;
                        sacInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            });

            document.querySelector(SELECTORS.addItemBtn).addEventListener('click', () => {
                appState.currentInvoice.items.push({ name: '', hsn: '', qty: 1, unit: 'PCS', rate: 0, discount: 0, gst: 18, cess: 0 });
                render();
            });

            document.querySelector(SELECTORS.sameAsBilling).addEventListener('change', (e) => {
                if (e.target.checked) {
                    appState.currentInvoice.details.deliveryAddress = appState.currentInvoice.details.recipientAddress;
                    render();
                }
            });

            document.querySelector(SELECTORS.newInvoiceBtn).addEventListener('click', () => {
                resetInvoiceState();
                render();
            });

            function navigate(targetId) {
                document.querySelectorAll('main section').forEach(sec => sec.classList.add('hidden'));
                document.querySelector(targetId).classList.remove('hidden');
                document.querySelectorAll('#main-nav .nav-link').forEach(link => {
                    link.classList.toggle('active', link.getAttribute('href') === targetId);
                });
            }
            document.querySelector(SELECTORS.mainNav).addEventListener('click', (e) => {
                if (e.target.tagName === 'A') { e.preventDefault(); navigate(e.target.getAttribute('href')); }
            });
            
            function switchTab(tabId) {
                document.querySelectorAll('#manage-data .tab-btn').forEach(btn => {
                    btn.classList.remove('border-slate-700', 'text-slate-700');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                document.getElementById(tabId).classList.add('border-slate-700', 'text-slate-700');
                
                ['profiles', 'products', 'customers', 'daily-sales', 'recurring', 'expenses', 'backup'].forEach(id => {
                    const contentEl = document.getElementById(`${id}-content`);
                    if (contentEl) contentEl.classList.add('hidden');
                });

                const activeContent = document.getElementById(tabId.replace('tab-','')+'-content');
                if (activeContent) activeContent.classList.remove('hidden');
            }
            document.getElementById('tab-profiles').addEventListener('click', () => switchTab('tab-profiles'));
            document.getElementById('tab-products').addEventListener('click', () => switchTab('tab-products'));
            document.getElementById('tab-customers').addEventListener('click', () => switchTab('tab-customers'));
            document.getElementById('tab-daily-sales').addEventListener('click', () => switchTab('tab-daily-sales'));
            document.getElementById('tab-recurring').addEventListener('click', () => switchTab('tab-recurring'));
            document.getElementById('tab-expenses').addEventListener('click', () => switchTab('tab-expenses'));
            document.getElementById('tab-backup').addEventListener('click', () => switchTab('tab-backup'));
            
            function populateDatalists() {
                const profileData = getActiveProfileData();
                document.querySelector(SELECTORS.customerDatalist).innerHTML = (profileData.customers || []).map(c => `<option value="${c.name}"></option>`).join('');
                document.querySelector(SELECTORS.productDatalist).innerHTML = (profileData.products || []).map(p => `<option value="${p.name}"></option>`).join('');
            }

            function renderProductsTable() {
                document.querySelector(SELECTORS.productsTable).innerHTML = (getActiveProfileData().products || []).map(p => `
                    <tr class="border-b">
                        <td class="p-2">${p.name}</td> <td class="p-2">${p.hsn}</td> <td class="p-2">${p.unit}</td>
                        <td class="p-2">‚Çπ${p.rate.toFixed(2)}</td> <td class="p-2">${p.gst}%</td>
                        <td class="p-2">
                            <button class="text-blue-500 text-xs edit-product-btn mr-2" data-id="${p.id}">Edit</button>
                            <button class="text-red-500 text-xs delete-product-btn" data-id="${p.id}">Delete</button>
                        </td>
                    </tr>`).join('');
            }
            
            function renderCustomersTable() {
                document.querySelector(SELECTORS.customersTable).innerHTML = (getActiveProfileData().customers || []).map(c => `
                    <tr class="border-b">
                        <td class="p-2">${c.name}</td> <td class="p-2">${c.gstin}</td> <td class="p-2">${c.state}</td> <td class="p-2">${c.pincode}</td>
                        <td class="p-2">
                            <button class="text-blue-500 text-xs edit-customer-btn mr-2" data-id="${c.id}">Edit</button>
                            <button class="text-red-500 text-xs delete-customer-btn mr-2" data-id="${c.id}">Delete</button>
                        </td>
                    </tr>`).join('');
            }

            function renderDailySalesTable() {
                const selectedDateEl = document.getElementById('daily-sale-date');
                if (!selectedDateEl) return;
                const selectedDateStr = selectedDateEl.value;
                if (!selectedDateStr) return;

                document.getElementById('selected-date-display').textContent = new Date(selectedDateStr).toLocaleDateString('en-GB');
                const salesForDate = (getActiveProfileData().dailySales || {})[selectedDateStr] || [];
                const tbody = document.getElementById('daily-sales-table');
                const generateBtn = document.getElementById('generate-consolidated-invoice-btn');

                if (salesForDate.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">No sales logged for ${selectedDateStr}.</td></tr>`;
                    generateBtn.disabled = true;
                } else {
                    tbody.innerHTML = salesForDate.map(sale => `
                        <tr class="border-b">
                            <td class="p-2">${sale.itemName}</td>
                            <td class="p-2">${sale.hsn}</td>
                            <td class="p-2 text-right">${sale.qty}</td>
                            <td class="p-2 text-right">‚Çπ${sale.rate.toFixed(2)}</td>
                            <td class="p-2 text-right font-semibold">‚Çπ${sale.total.toFixed(2)}</td>
                            <td class="p-2 text-center">
                                <button class="text-red-500 hover:text-red-700 delete-daily-sale-btn text-xl font-bold" data-sale-id="${sale.id}" data-sale-date="${selectedDateStr}">&times;</button>
                            </td>
                        </tr>`).join('');
                    generateBtn.disabled = false;
                }
            }

            function renderStatusBadge(status) {
                const statusColors = { 'Draft': 'bg-gray-200 text-gray-800', 'Sent': 'bg-blue-200 text-blue-800', 'Paid': 'bg-green-200 text-green-800', 'Partially Paid': 'bg-yellow-200 text-yellow-800', 'Overdue': 'bg-red-200 text-red-800' };
                return `<span class="status-badge ${statusColors[status] || 'bg-gray-200'}">${status}</span>`;
            }

            function renderInvoicesTable() {
                document.querySelector(SELECTORS.invoicesTable).innerHTML = (getActiveProfileData().invoices || []).map((inv, index) => {
                    let status = inv.status || 'Draft';
                    if ((status === 'Sent' || status === 'Partially Paid') && inv.details.invoiceDate) {
                        const invoiceDate = new Date(inv.details.invoiceDate);
                        const dueDate = new Date(invoiceDate.setDate(invoiceDate.getDate() + 30));
                        if (new Date() > dueDate) status = 'Overdue';
                    }
                    const invoiceId = inv.id || index;
                    let actionsHtml = `<button class="text-blue-500 text-xs view-invoice-btn" data-id="${invoiceId}">View</button>`;
                    if (status === 'Draft') actionsHtml += `<button class="text-green-600 text-xs mark-sent-btn ml-2" data-id="${invoiceId}">Mark Sent</button>`;
                    if (status === 'Sent' || status === 'Partially Paid' || status === 'Overdue') actionsHtml += `<button class="text-purple-600 text-xs record-payment-btn ml-2" data-id="${invoiceId}">Record Payment</button>`;
                    actionsHtml += `<button class="text-indigo-600 text-xs make-recurring-btn ml-2" data-id="${invoiceId}">Make Recurring</button>`;
                    actionsHtml += `<button class="text-red-500 text-xs delete-invoice-btn ml-2" data-id="${invoiceId}">Delete</button>`;
                    return `<tr class="border-b">
                        <td class="p-2">${inv.details.invoiceNo}</td>
                        <td class="p-2">${inv.details.invoiceDate}</td>
                        <td class="p-2">${inv.details.recipientName}</td>
                        <td class="p-2">‚Çπ${inv.details.total.toFixed(2)}</td>
                        <td class="p-2"><span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${inv.details.docTypeLabel}</span></td>
                        <td class="p-2">${renderStatusBadge(status)}</td>
                        <td class="p-2">${actionsHtml}</td>
                    </tr>`;
                }).join('');
            }
            
            function renderRecurringTable() {
                document.querySelector(SELECTORS.recurringTable).innerHTML = (getActiveProfileData().recurring || []).map((rec, index) => `
                    <tr class="border-b">
                        <td class="p-2">${rec.templateInvoice.details.recipientName}</td>
                        <td class="p-2">‚Çπ${rec.templateInvoice.details.total.toFixed(2)}</td>
                        <td class="p-2 capitalize">${rec.frequency}</td>
                        <td class="p-2">${rec.nextDueDate}</td>
                        <td class="p-2">
                            <button class="text-red-500 text-xs delete-recurring-btn" data-index="${index}">Delete</button>
                        </td>
                    </tr>`).join('');
            }

            function renderExpensesTable() {
                 document.querySelector(SELECTORS.expensesTable).innerHTML = (getActiveProfileData().expenses || []).map((exp, index) => `
                    <tr class="border-b">
                        <td class="p-2">${exp.date}</td>
                        <td class="p-2">${exp.category}</td>
                        <td class="p-2">${exp.description}</td>
                        <td class="p-2">‚Çπ${exp.amount.toFixed(2)}</td>
                        <td class="p-2">
                            <button class="text-blue-500 text-xs edit-expense-btn" data-index="${index}">Edit</button>
                            <button class="text-red-500 text-xs delete-expense-btn ml-2" data-index="${index}">Delete</button>
                        </td>
                    </tr>`).join('');
            }
            
            function saveOrUpdateInvoice() {
                const profileData = getActiveProfileData();
                const currentInvoice = JSON.parse(JSON.stringify(appState.currentInvoice));
                
                if (!currentInvoice.id) currentInvoice.id = String(Date.now());

                const docTypeSelect = document.querySelector(SELECTORS.documentType);
                currentInvoice.details.docTypeLabel = docTypeSelect.options[docTypeSelect.selectedIndex].text;
                currentInvoice.details.total = calculateTotals(currentInvoice).grandTotal;

                let updatedInvoices = [...(profileData.invoices || [])];
                const existingIndex = updatedInvoices.findIndex(inv => inv.id === currentInvoice.id);

                if (existingIndex > -1) {
                    updatedInvoices[existingIndex] = currentInvoice;
                } else {
                    updatedInvoices.push(currentInvoice);
                }
                
                const invoiceNo = currentInvoice.details.invoiceNo;
                const prefix = profileData.settings.invoicePrefix;
                if(invoiceNo.startsWith(prefix)) {
                    const numberPart = parseInt(invoiceNo.substring(prefix.length));
                    if (!isNaN(numberPart) && numberPart > profileData.settings.lastInvoiceNumber) {
                        profileData.settings.lastInvoiceNumber = numberPart;
                    }
                }
                
                profileData.invoices = updatedInvoices;
                saveDataToLocalStorage();
            }

            document.querySelector(SELECTORS.saveDraftBtn).addEventListener('click', () => {
                if (!validateForm()) { showToast('Please fix the errors before saving.', true); return; }
                saveOrUpdateInvoice();
                showToast('Document saved!');
                navigate('#reports');
                renderAll();
            });
            
            function showModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
            function hideModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
            
            function setupModals() {
                // Product Modals
                document.getElementById('add-product-modal').innerHTML = `<div class="modal-content"><h2 class="text-2xl font-bold mb-4">Add New Product</h2><form id="add-product-form" class="space-y-4"><input type="text" id="new-product-name" class="input-field" placeholder="Product Name" required><input type="text" id="new-product-hsn" class="input-field" placeholder="HSN/SAC Code" required><input type="text" id="new-product-unit" class="input-field" placeholder="Unit (e.g., PCS, KG)" required><input type="number" id="new-product-rate" class="input-field" placeholder="Rate (‚Çπ)" required step="0.01"><input type="number" id="new-product-gst" class="input-field" placeholder="GST Rate (%)" required step="0.1"><input type="number" id="new-product-cess" class="input-field" placeholder="Cess Rate (%)" value="0" required step="0.1"><div class="flex justify-end space-x-2"><button type="button" id="cancel-add-product" class="btn-secondary">Cancel</button><button type="submit" class="btn-primary">Save Product</button></div></form></div>`;
                document.getElementById('edit-product-modal').innerHTML = `<div class="modal-content"><h2 class="text-2xl font-bold mb-4">Edit Product</h2><form id="edit-product-form" class="space-y-4"><input type="hidden" id="edit-product-id"><input type="text" id="edit-product-name" class="input-field" placeholder="Product Name" required><input type="text" id="edit-product-hsn" class="input-field" placeholder="HSN/SAC Code" required><input type="text" id="edit-product-unit" class="input-field" placeholder="Unit (e.g., PCS, KG)" required><input type="number" id="edit-product-rate" class="input-field" placeholder="Rate (‚Çπ)" required step="0.01"><input type="number" id="edit-product-gst" class="input-field" placeholder="GST Rate (%)" required step="0.1"><input type="number" id="edit-product-cess" class="input-field" placeholder="Cess Rate (%)" required step="0.1"><div class="flex justify-end space-x-2"><button type="button" id="cancel-edit-product" class="btn-secondary">Cancel</button><button type="submit" class="btn-primary">Save Changes</button></div></form></div>`;
                
                // Customer Modals
                document.getElementById('add-customer-modal').innerHTML = `<div class="modal-content"><h2 class="text-2xl font-bold mb-4">Add New Customer</h2><form id="add-customer-form" class="space-y-4"><input type="text" id="new-customer-name" class="input-field" placeholder="Customer Name" required><input type="text" id="new-customer-gstin" class="input-field" placeholder="GSTIN"><textarea id="new-customer-address" class="input-field" placeholder="Address"></textarea><input type="text" id="new-customer-pincode" class="input-field" placeholder="PIN Code" required><select id="new-customer-state" class="input-field"></select><div class="flex justify-end space-x-2"><button type="button" id="cancel-add-customer" class="btn-secondary">Cancel</button><button type="submit" class="btn-primary">Save Customer</button></div></form></div>`;
                document.getElementById('edit-customer-modal').innerHTML = `<div class="modal-content"><h2 class="text-2xl font-bold mb-4">Edit Customer</h2><form id="edit-customer-form" class="space-y-4"><input type="hidden" id="edit-customer-id"><input type="text" id="edit-customer-name" class="input-field" placeholder="Customer Name" required><input type="text" id="edit-customer-gstin" class="input-field" placeholder="GSTIN"><textarea id="edit-customer-address" class="input-field" placeholder="Address"></textarea><input type="text" id="edit-customer-pincode" class="input-field" placeholder="PIN Code" required><select id="edit-customer-state" class="input-field"></select><div class="flex justify-end space-x-2"><button type="button" id="cancel-edit-customer" class="btn-secondary">Cancel</button><button type="submit" class="btn-primary">Save Changes</button></div></form></div>`;
                
                // Product Listeners
                document.querySelector(SELECTORS.addProductBtn).addEventListener('click', () => showModal('add-product-modal'));
                document.getElementById('cancel-add-product').addEventListener('click', () => hideModal('add-product-modal'));
                document.getElementById('add-product-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newProduct = { id: String(Date.now()), name: document.getElementById('new-product-name').value, hsn: document.getElementById('new-product-hsn').value, unit: document.getElementById('new-product-unit').value, rate: safeParseFloat(document.getElementById('new-product-rate').value), gst: safeParseFloat(document.getElementById('new-product-gst').value), cess: safeParseFloat(document.getElementById('new-product-cess').value) };
                    getActiveProfileData().products.push(newProduct);
                    saveDataToLocalStorage();
                    renderAll();
                    hideModal('add-product-modal'); e.target.reset();
                });
                
                document.getElementById('cancel-edit-product').addEventListener('click', () => hideModal('edit-product-modal'));
                document.getElementById('edit-product-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = document.getElementById('edit-product-id').value;
                    const profileData = getActiveProfileData();
                    profileData.products = profileData.products.map(p => p.id === id ? { ...p, name: document.getElementById('edit-product-name').value, hsn: document.getElementById('edit-product-hsn').value, unit: document.getElementById('edit-product-unit').value, rate: safeParseFloat(document.getElementById('edit-product-rate').value), gst: safeParseFloat(document.getElementById('edit-product-gst').value), cess: safeParseFloat(document.getElementById('edit-product-cess').value) } : p);
                    saveDataToLocalStorage();
                    renderAll();
                    hideModal('edit-product-modal');
                    showToast('Product updated successfully!');
                });

                Object.keys(appState.indianStates).forEach(s => {
                    document.getElementById('new-customer-state').add(new Option(s, s));
                    document.getElementById('edit-customer-state').add(new Option(s, s));
                });

                document.querySelector(SELECTORS.addCustomerBtn).addEventListener('click', () => showModal('add-customer-modal'));
                document.getElementById('cancel-add-customer').addEventListener('click', () => hideModal('add-customer-modal'));
                document.getElementById('add-customer-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newCustomer = { id: String(Date.now()), name: document.getElementById('new-customer-name').value, gstin: document.getElementById('new-customer-gstin').value, address: document.getElementById('new-customer-address').value, pincode: document.getElementById('new-customer-pincode').value, state: document.getElementById('new-customer-state').value };
                    getActiveProfileData().customers.push(newCustomer);
                    saveDataToLocalStorage();
                    renderAll();
                    hideModal('add-customer-modal'); e.target.reset();
                });
                
                document.getElementById('cancel-edit-customer').addEventListener('click', () => hideModal('edit-customer-modal'));
                document.getElementById('edit-customer-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = document.getElementById('edit-customer-id').value;
                    const profileData = getActiveProfileData();
                    profileData.customers = profileData.customers.map(c => c.id === id ? { ...c, name: document.getElementById('edit-customer-name').value, gstin: document.getElementById('edit-customer-gstin').value, address: document.getElementById('edit-customer-address').value, pincode: document.getElementById('edit-customer-pincode').value, state: document.getElementById('edit-customer-state').value } : c);
                    saveDataToLocalStorage();
                    renderAll();
                    hideModal('edit-customer-modal');
                    showToast('Customer updated successfully!');
                });

                document.getElementById('cancel-import').addEventListener('click', () => hideModal('import-modal'));
                document.querySelector(SELECTORS.importProductsBtn).addEventListener('click', () => {
                    document.getElementById('import-title').textContent = 'Import Products from Excel';
                    document.getElementById('import-instructions').innerHTML = 'Required columns: <strong>name, hsn, unit, rate, gst, cess</strong>. All other columns will be ignored.';
                    document.getElementById('confirm-import-btn').dataset.type = 'products';
                    showModal('import-modal');
                });
                document.querySelector(SELECTORS.importCustomersBtn).addEventListener('click', () => {
                    document.getElementById('import-title').textContent = 'Import Customers from Excel';
                    document.getElementById('import-instructions').innerHTML = 'Required columns: <strong>name, gstin, address, state, pincode</strong>. The state must match the exact spelling from the dropdown.';
                    document.getElementById('confirm-import-btn').dataset.type = 'customers';
                    showModal('import-modal');
                });
                document.getElementById('confirm-import-btn').addEventListener('click', handleFileImport);

                document.getElementById('cancel-payment-btn').addEventListener('click', () => hideModal('record-payment-modal'));
                document.getElementById('record-payment-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const invoiceId = document.getElementById('payment-invoice-id').value;
                    const amount = safeParseFloat(document.getElementById('payment-amount').value);
                    const date = document.getElementById('payment-date').value;
                    const notes = document.getElementById('payment-notes').value;
                    if (!invoiceId || !amount || !date) { showToast('Invalid payment details.', true); return; }

                    const invoices = getActiveProfileData().invoices;
                    const invoice = invoices.find(inv => (inv.id || inv.details.invoiceNo) == invoiceId);
                    if (!invoice) { showToast('Could not find document.', true); return; }
                    
                    invoice.payments = [...(invoice.payments || []), { date, amount, notes }];
                    const totalPaid = invoice.payments.reduce((sum, p) => sum + p.amount, 0);
                    invoice.status = (totalPaid >= invoice.details.total) ? 'Paid' : 'Partially Paid';
                    saveDataToLocalStorage();
                    renderAll();
                    hideModal('record-payment-modal');
                    showToast('Payment recorded!');
                });

                document.getElementById('cancel-recurring-btn').addEventListener('click', () => hideModal('make-recurring-modal'));
                document.getElementById('make-recurring-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const invoiceId = document.getElementById('recurring-invoice-id').value;
                    const frequency = document.getElementById('recurring-frequency').value;
                    const nextDueDate = document.getElementById('recurring-next-date').value;
                    if(!invoiceId || !frequency || !nextDueDate) { showToast('Invalid recurring details.', true); return; }
                    
                    const invoice = getActiveProfileData().invoices.find(inv => (inv.id || inv.details.invoiceNo) == invoiceId);
                    if (!invoice) { showToast('Could not find document.', true); return; }

                    getActiveProfileData().recurring.push({ id: String(Date.now()), frequency, nextDueDate, templateInvoice: JSON.parse(JSON.stringify(invoice)) });
                    saveDataToLocalStorage();
                    renderAll();
                    hideModal('make-recurring-modal');
                    showToast('Recurring schedule saved!');
                });

                document.querySelector(SELECTORS.addExpenseBtn).addEventListener('click', () => {
                    document.getElementById('expense-modal-title').textContent = 'Add Expense';
                    document.getElementById('expense-form').reset();
                    document.getElementById('expense-id').value = '';
                    showModal('expense-modal');
                });
                document.getElementById('cancel-expense-btn').addEventListener('click', () => hideModal('expense-modal'));
                document.getElementById('expense-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const expenseId = document.getElementById('expense-id').value;
                    const expense = { id: expenseId || String(Date.now()), date: document.getElementById('expense-date').value, category: document.getElementById('expense-category').value, description: document.getElementById('expense-description').value, amount: safeParseFloat(document.getElementById('expense-amount').value) };
                    
                    const expenses = getActiveProfileData().expenses;
                    if (expenseId) {
                        const index = expenses.findIndex(ex => ex.id === expenseId);
                        expenses[index] = expense;
                    } else {
                        expenses.push(expense);
                    }
                    saveDataToLocalStorage();
                    renderAll();
                    hideModal('expense-modal');
                    showToast(`Expense ${expenseId ? 'updated' : 'added'}!`);
                });
            }

            function handleFileImport(event) {
                const type = event.target.dataset.type;
                const file = document.getElementById('import-file-input').files[0];
                if (!file) { showToast('Please select a file to import.', true); return; }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(worksheet);
                        if (json.length === 0) { showToast('File is empty or invalid.', true); return; }
                        
                        const profileData = getActiveProfileData();
                        if (type === 'products') {
                            profileData.products = json.map(row => ({ id: String(Date.now() + Math.random()), name: row.name || 'N/A', hsn: String(row.hsn || ''), unit: row.unit || 'NOS', rate: safeParseFloat(row.rate), gst: safeParseFloat(row.gst), cess: safeParseFloat(row.cess || 0) }));
                        } else if (type === 'customers') {
                            profileData.customers = json.map(row => ({ id: String(Date.now() + Math.random()), name: row.name || 'N/A', gstin: row.gstin || '', address: row.address || '', state: row.state || '', pincode: row.pincode || '' }));
                        }
                        
                        saveDataToLocalStorage();
                        renderAll();
                        hideModal('import-modal');
                        document.getElementById('import-file-input').value = '';
                        showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} imported successfully!`);

                    } catch (error) {
                        console.error("Import error:", error);
                        showToast('Failed to parse the Excel file.', true);
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            function showDeleteConfirmation(message, onConfirm) {
                document.getElementById('confirm-message').textContent = message;
                const confirmBtn = document.getElementById('confirm-delete-btn');
                const cancelBtn = document.getElementById('cancel-delete-btn');
                const confirmHandler = () => { onConfirm(); hideModal('confirm-delete-modal'); cleanup(); };
                const cancelHandler = () => { hideModal('confirm-delete-modal'); cleanup(); };
                function cleanup() {
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                }
                confirmBtn.addEventListener('click', confirmHandler, { once: true });
                cancelBtn.addEventListener('click', cancelHandler, { once: true });
                showModal('confirm-delete-modal');
            }

            document.querySelector(SELECTORS.manageDataSection).addEventListener('click', (e) => {
                const target = e.target;
                const id = target.dataset.id;
                const index = target.dataset.index;
                const profileData = getActiveProfileData();
                
                if (target.classList.contains('delete-product-btn')) {
                    showDeleteConfirmation('Are you sure you want to delete this product?', () => { 
                        profileData.products = profileData.products.filter(p => p.id !== id);
                        saveDataToLocalStorage(); renderAll();
                    });
                } else if (target.classList.contains('edit-product-btn')) {
                    const product = profileData.products.find(p => p.id === id);
                    if (product) {
                        document.getElementById('edit-product-id').value = product.id;
                        document.getElementById('edit-product-name').value = product.name;
                        document.getElementById('edit-product-hsn').value = product.hsn;
                        document.getElementById('edit-product-unit').value = product.unit;
                        document.getElementById('edit-product-rate').value = product.rate;
                        document.getElementById('edit-product-gst').value = product.gst;
                        document.getElementById('edit-product-cess').value = product.cess;
                        showModal('edit-product-modal');
                    }
                }
                
                if (target.classList.contains('delete-customer-btn')) {
                    showDeleteConfirmation('Are you sure you want to delete this customer?', () => { 
                        profileData.customers = profileData.customers.filter(c => c.id !== id);
                        saveDataToLocalStorage(); renderAll();
                    });
                } else if (target.classList.contains('edit-customer-btn')) {
                    const customer = profileData.customers.find(c => c.id === id);
                    if(customer) {
                        document.getElementById('edit-customer-id').value = customer.id;
                        document.getElementById('edit-customer-name').value = customer.name;
                        document.getElementById('edit-customer-gstin').value = customer.gstin;
                        document.getElementById('edit-customer-address').value = customer.address;
                        document.getElementById('edit-customer-pincode').value = customer.pincode;
                        document.getElementById('edit-customer-state').value = customer.state;
                        showModal('edit-customer-modal');
                    }
                }

                if (target.classList.contains('delete-recurring-btn')) {
                    showDeleteConfirmation('Are you sure you want to delete this recurring schedule?', () => {
                        profileData.recurring.splice(index, 1);
                        saveDataToLocalStorage(); renderAll();
                        showToast('Recurring schedule deleted.');
                    });
                }

                if (target.classList.contains('delete-daily-sale-btn')) {
                    const saleId = target.dataset.saleId;
                    const saleDate = target.dataset.saleDate;
                    showDeleteConfirmation('Are you sure you want to delete this logged sale?', () => {
                        const dailySales = profileData.dailySales || {};
                        if (dailySales[saleDate]) {
                            dailySales[saleDate] = dailySales[saleDate].filter(s => s.id !== saleId);
                             if (dailySales[saleDate].length === 0) delete dailySales[saleDate];
                        }
                        saveDataToLocalStorage(); renderAll();
                        showToast('Sale entry deleted.');
                    });
                }
            });
            
            document.querySelector(SELECTORS.reportsSection).addEventListener('click', (e) => {
                const target = e.target;
                const invoiceId = target.dataset.id;
                if (!invoiceId) return;

                const invoices = getActiveProfileData().invoices;
                const invoice = invoices.find(inv => inv.id === invoiceId);
                if (!invoice) { showToast('Could not find document.', true); return; }

                if (target.classList.contains('view-invoice-btn')) {
                    appState.currentInvoice = JSON.parse(JSON.stringify(invoice));
                    navigate('#create-invoice');
                    render();
                } else if (target.classList.contains('mark-sent-btn')) {
                    invoice.status = 'Sent';
                    saveDataToLocalStorage(); renderAll();
                    showToast('Document marked as sent.');
                } else if (target.classList.contains('record-payment-btn')) {
                    document.getElementById('payment-invoice-id').value = invoiceId;
                    document.getElementById('payment-invoice-no').textContent = invoice.details.invoiceNo;
                    const totalPaid = (invoice.payments || []).reduce((sum, p) => sum + p.amount, 0);
                    const amountDue = invoice.details.total - totalPaid;
                    document.getElementById('payment-total-amount').textContent = `‚Çπ${invoice.details.total.toFixed(2)}`;
                    document.getElementById('payment-amount-due').textContent = `‚Çπ${amountDue.toFixed(2)}`;
                    document.getElementById('payment-amount').value = amountDue.toFixed(2);
                    document.getElementById('payment-amount').max = amountDue;
                    showModal('record-payment-modal');
                } else if (target.classList.contains('make-recurring-btn')) {
                    document.getElementById('recurring-invoice-id').value = invoiceId;
                    document.getElementById('recurring-invoice-no').textContent = invoice.details.invoiceNo;
                    showModal('make-recurring-modal');
                } else if (target.classList.contains('delete-invoice-btn')) {
                    showDeleteConfirmation('Are you sure you want to delete this document?', () => {
                        getActiveProfileData().invoices = invoices.filter(inv => inv.id !== invoiceId);
                        saveDataToLocalStorage(); renderAll();
                        showToast('Document deleted.');
                    });
                }
            });
            
            document.getElementById('save-voucher-btn').addEventListener('click', () => {
                const details = appState.currentInvoice.details;
                if (!details.invoiceNo || !details.invoiceDate) { showToast('Voucher Number and Date are required.', true); return; }
                saveOrUpdateInvoice();
                showToast('Voucher saved successfully!');
                navigate('#reports');
                renderAll();
            });

            document.getElementById('daily-sale-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const errorEl = document.getElementById('daily-sale-total-error');
                errorEl.classList.add('hidden');

                const saleDateStr = document.getElementById('daily-sale-date').value;
                if (!saleDateStr) { showToast('Please select a date for the sale.', true); return; }

                const itemName = document.getElementById('daily-sale-item').value;
                const hsn = document.getElementById('daily-sale-hsn').value;
                const qty = safeParseFloat(document.getElementById('daily-sale-qty').value);
                const rate = safeParseFloat(document.getElementById('daily-sale-rate').value);
                const total = qty * rate;

                if (total >= 200) { errorEl.classList.remove('hidden'); return; }

                const newSale = { id: String(Date.now()), itemName, hsn, qty, rate, total };
                const profileData = getActiveProfileData();
                if (!profileData.dailySales[saleDateStr]) profileData.dailySales[saleDateStr] = [];
                profileData.dailySales[saleDateStr].push(newSale);
                saveDataToLocalStorage();
                renderAll();
                showToast('Sale logged successfully!');
                e.target.reset();
                document.getElementById('daily-sale-item').focus();
            });

            document.getElementById('generate-consolidated-invoice-btn').addEventListener('click', () => {
                const saleDateStr = document.getElementById('daily-sale-date').value;
                if (!saleDateStr) { showToast('Please select a date.', true); return; }
                const profileData = getActiveProfileData();
                const salesForDate = (profileData.dailySales || {})[saleDateStr] || [];
                if (salesForDate.length === 0) { showToast('No sales logged for selected date.', true); return; }

                const summary = {};
                salesForDate.forEach(sale => {
                    if (!summary[sale.hsn]) {
                        const product = profileData.products.find(p => p.hsn === sale.hsn);
                        summary[sale.hsn] = { name: `Consolidated Sales for HSN ${sale.hsn}`, hsn: sale.hsn, qty: 0, taxableValue: 0, gst: product ? product.gst : 18, cess: product ? product.cess : 0, unit: product ? product.unit : 'NOS' };
                    }
                    summary[sale.hsn].qty += sale.qty;
                    summary[sale.hsn].taxableValue += sale.total;
                });

                resetInvoiceState();
                const newInvoice = appState.currentInvoice;
                newInvoice.details.recipientName = 'Consolidated B2C Sales (< ‚Çπ200)';
                newInvoice.details.recipientAddress = `For sales on ${new Date(saleDateStr).toLocaleDateString('en-GB')}`;
                newInvoice.details.recipientGstin = '';
                newInvoice.details.isConsolidated = true;
                newInvoice.items = Object.values(summary).map(item => ({ name: item.name, hsn: item.hsn, qty: item.qty, unit: item.unit, rate: item.taxableValue / item.qty, discount: 0, gst: item.gst, cess: item.cess }));
                appState.currentInvoice = newInvoice;
                
                navigate('#create-invoice');
                render();
                showToast('Consolidated invoice generated!');
            });

            document.querySelector(SELECTORS.expensesTable).addEventListener('click', (e) => {
                const target = e.target;
                const index = target.dataset.index;
                if (index === undefined) return;
                const expenses = getActiveProfileData().expenses;

                if (target.classList.contains('edit-expense-btn')) {
                    const expense = expenses[index];
                    document.getElementById('expense-modal-title').textContent = 'Edit Expense';
                    document.getElementById('expense-id').value = expense.id;
                    document.getElementById('expense-date').value = expense.date;
                    document.getElementById('expense-category').value = expense.category;
                    document.getElementById('expense-description').value = expense.description;
                    document.getElementById('expense-amount').value = expense.amount;
                    showModal('expense-modal');
                } else if (target.classList.contains('delete-expense-btn')) {
                    showDeleteConfirmation('Are you sure you want to delete this expense?', () => {
                        expenses.splice(index, 1);
                        saveDataToLocalStorage(); renderAll();
                        showToast('Expense deleted.');
                    });
                }
            });

            function downloadFile(filename, content, mimeType) {
                const a = document.createElement('a');
                const blob = new Blob([content], { type: mimeType });
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                URL.revokeObjectURL(a.href);
            }

            document.getElementById('export-zoho').addEventListener('click', () => {
                const invoices = getActiveProfileData().invoices;
                if (!invoices || invoices.length === 0) { showToast('No documents to export.', true); return; }
                let csvContent = "Customer Name,Invoice Date,Invoice Number,Item Name,Quantity,Rate,Tax Name,Tax Amount\n";
                invoices.forEach(inv => { inv.items.forEach(item => { const taxAmount = (item.rate * item.qty * item.gst) / 100; csvContent += `"${inv.details.recipientName}",${inv.details.invoiceDate},${inv.details.invoiceNo},"${item.name}",${item.qty},${item.rate},GST${item.gst},${taxAmount.toFixed(2)}\n`; }); });
                downloadFile('zoho_export.csv', csvContent, 'text/csv;charset=utf-8;');
            });
            
            document.getElementById('export-tally').addEventListener('click', () => {
                const invoices = getActiveProfileData().invoices;
                if (!invoices || invoices.length === 0) { showToast('No invoices to export.', true); return; }
                const companyName = invoices[0].details.supplierName || 'My Business';
                let xmlContent = `<ENVELOPE><HEADER><TALLYREQUEST>Import Data</TALLYREQUEST></HEADER><BODY><IMPORTDATA><REQUESTDESC><REPORTNAME>Vouchers</REPORTNAME><STATICVARIABLES><SVCURRENTCOMPANY>${companyName}</SVCURRENTCOMPANY></STATICVARIABLES></REQUESTDESC><REQUESTDATA>`;

                invoices.forEach(inv => {
                    const totals = calculateTotals(inv);
                    const isInter = isInterState(inv.details.supplierGstin, inv.details.placeOfSupply);
                    let inventoryEntries = '';
                    inv.items.forEach(item => {
                        const taxableValue = (item.qty * item.rate) - (item.discount || 0);
                        inventoryEntries += `<ALLINVENTORYENTRIES.LIST><STOCKITEMNAME>${item.name}</STOCKITEMNAME><ISDEEMEDPOSITIVE>No</ISDEEMEDPOSITIVE><RATE>${item.rate}/ ${item.unit}</RATE><AMOUNT>-${taxableValue.toFixed(2)}</AMOUNT><ACTUALQTY>${item.qty} ${item.unit}</ACTUALQTY><BILLEDQTY>${item.qty} ${item.unit}</BILLEDQTY></ALLINVENTORYENTRIES.LIST>`;
                    });
                    const tallyDate = inv.details.invoiceDate.replace(/-/g, '');
                    xmlContent += `<TALLYMESSAGE xmlns:UDF="TallyUDF"><VOUCHER VCHTYPE="Sales" ACTION="Create"><DATE>${tallyDate}</DATE><VOUCHERTYPENAME>Sales</VOUCHERTYPENAME><VOUCHERNUMBER>${inv.details.invoiceNo}</VOUCHERNUMBER><PARTYLEDGERNAME>${inv.details.recipientName}</PARTYLEDGERNAME><PERSISTEDVIEW>Invoice Voucher View</PERSISTEDVIEW><ALLLEDGERENTRIES.LIST><LEDGERNAME>${inv.details.recipientName}</LEDGERNAME><ISDEEMEDPOSITIVE>Yes</ISDEEMEDPOSITIVE><AMOUNT>${totals.grandTotal.toFixed(2)}</AMOUNT></ALLLEDGERENTRIES.LIST><ALLLEDGERENTRIES.LIST><LEDGERNAME>Sales</LEDGERNAME><ISDEEMEDPOSITIVE>No</ISDEEMEDPOSITIVE><AMOUNT>-${totals.subtotal.toFixed(2)}</AMOUNT>${inventoryEntries}</ALLLEDGERENTRIES.LIST>`;
                    if (isInter) { if(totals.igst > 0) xmlContent += `<ALLLEDGERENTRIES.LIST><LEDGERNAME>Output IGST</LEDGERNAME><ISDEEMEDPOSITIVE>No</ISDEEMEDPOSITIVE><AMOUNT>-${totals.igst.toFixed(2)}</AMOUNT></ALLLEDGERENTRIES.LIST>`; } 
                    else { if(totals.cgst > 0) xmlContent += `<ALLLEDGERENTRIES.LIST><LEDGERNAME>Output CGST</LEDGERNAME><ISDEEMEDPOSITIVE>No</ISDEEMEDPOSITIVE><AMOUNT>-${totals.cgst.toFixed(2)}</AMOUNT></ALLLEDGERENTRIES.LIST>`; if(totals.sgst > 0) xmlContent += `<ALLLEDGERENTRIES.LIST><LEDGERNAME>Output SGST</LEDGERNAME><ISDEEMEDPOSITIVE>No</ISDEEMEDPOSITIVE><AMOUNT>-${totals.sgst.toFixed(2)}</AMOUNT></ALLLEDGERENTRIES.LIST>`; }
                    xmlContent += `</VOUCHER></TALLYMESSAGE>`;
                });
                xmlContent += `</REQUESTDATA></IMPORTDATA></BODY></ENVELOPE>`;
                downloadFile('daybook.xml', xmlContent, 'application/xml');
            });

            document.getElementById('export-excel').addEventListener('click', () => {
                const invoices = getActiveProfileData().invoices;
                if (!invoices || invoices.length === 0) { showToast('No documents to export.', true); return; }
                let tableHtml = '<table><thead><tr><th>Doc No</th><th>Date</th><th>Customer</th><th>Item</th><th>Qty</th><th>Rate</th><th>Taxable</th><th>GST %</th><th>Total</th></tr></thead><tbody>';
                invoices.forEach(inv => { inv.items.forEach(item => { const taxable = item.rate * item.qty; const total = taxable * (1 + item.gst / 100); tableHtml += `<tr><td>${inv.details.invoiceNo}</td><td>${inv.details.invoiceDate}</td><td>${inv.details.recipientName}</td><td>${item.name}</td><td>${item.qty}</td><td>${item.rate}</td><td>${taxable.toFixed(2)}</td><td>${item.gst}</td><td>${total.toFixed(2)}</td></tr>`; }); });
                tableHtml += '</tbody></table>';
                const excelContent = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body>${tableHtml}</body></html>`;
                downloadFile('documents_export.xls', excelContent, 'application/vnd.ms-excel');
            });
            document.getElementById('export-json').addEventListener('click', () => {
                const invoices = getActiveProfileData().invoices;
                if (!invoices || invoices.length === 0) { showToast('No documents to export.', true); return; }
                downloadFile('documents_export.json', JSON.stringify(invoices, null, 2), 'application/json;charset=utf-8;');
            });

            async function callGeminiAPI(payload, retries = 3, delay = 1000) {
                const settings = getActiveProfileData().settings;
                const apiKey = settings.geminiApiKey;
            
                if (!apiKey) {
                    throw new Error("API Key is missing. Please add it in your profile settings to use AI features.");
                }
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        if (response.status === 429 && retries > 0) { await new Promise(res => setTimeout(res, delay)); return callGeminiAPI(payload, retries - 1, delay * 2); }
                        if (response.status === 400) {
                            const errorData = await response.json();
                            throw new Error(`API Key is invalid or expired. Please check your key in Profile Settings. Server message: ${errorData.error.message}`);
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]) { return result; } 
                    else { if (result.candidates?.[0]?.finishReason !== 'STOP') throw new Error(`Request blocked. Reason: ${result.candidates[0].finishReason}`); throw new Error("No content in API response."); }
                } catch (error) {
                    console.error("Error in callGeminiAPI:", error);
                    // No automatic retry for user-fixable errors like missing/bad API key
                    if (error.message.includes("API Key is missing") || error.message.includes("API Key is invalid")) {
                         throw error;
                    }
                    if (retries > 0) { 
                        await new Promise(res => setTimeout(res, delay)); 
                        return callGeminiAPI(payload, retries - 1, delay * 2); 
                    }
                    throw error;
                }
            }


            document.getElementById('ai-suggest-item-btn').addEventListener('click', () => showModal('ai-suggest-modal'));
            document.getElementById('close-ai-suggest-modal')?.addEventListener('click', () => hideModal('ai-suggest-modal'));
            document.getElementById('get-ai-suggestions-btn').addEventListener('click', async () => {
                const promptText = document.getElementById('ai-item-prompt').value;
                if (!promptText) { showToast('Please describe an item.', true); return; }
                const loader = document.getElementById('ai-suggestions-loader');
                const container = document.getElementById('ai-suggestions-container');
                loader.classList.remove('hidden');
                container.innerHTML = '';
                const schema = { type: "OBJECT", properties: { "suggestions": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "name": { "type": "STRING" }, "hsn": { "type": "STRING" }, "rate": { "type": "NUMBER" }, "gst": { "type": "NUMBER" } }, "required": ["name", "hsn", "rate", "gst"] } } } };
                const GST_2_0_RULEBOOK = `You are an Indian GST expert providing data for an invoice. All your responses must be strictly based on the GST 2.0 Reforms, effective September 22, 2025. Key rates have changed:
- Standard Rate for most items is now 18%.
- Merit Rate for common goods is 5%.
- Key changes: Cement is 18%. Air Conditioners are 18%. All Televisions are 18%. Hair oil, soap, and toothpaste are 5%. Small cars are 18%. Aerated drinks are 40%.
Do not use any pre-reform GST rates (like 28% or 12%) unless it is one of the new special rates (e.g., 3% for gold, 0.25% for diamonds).`;
                const prompt = `${GST_2_0_RULEBOOK} Now, based on the user's request for "${promptText}", provide 3 relevant product/service suggestions for a GST invoice in India. Give a professional name, likely HSN/SAC code, typical INR rate, and GST percentage.`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
                try {
                    const result = await callGeminiAPI(payload);
                    const text = result.candidates[0].content.parts[0].text;
                    let suggestions;
                    try { suggestions = JSON.parse(text).suggestions; } catch (e) { throw new Error("AI returned invalid format."); }
                    if (suggestions && suggestions.length > 0) {
                        suggestions.forEach(s => {
                            const btn = document.createElement('button');
                            btn.className = 'w-full text-left p-3 bg-gray-100 hover:bg-blue-100 rounded-lg transition-colors';
                            btn.innerHTML = `<strong>${s.name}</strong><br><span class="text-sm text-gray-600">HSN: ${s.hsn} | Rate: ‚Çπ${s.rate.toFixed(2)} | GST: ${s.gst}%</span>`;
                            btn.onclick = () => { appState.currentInvoice.items.push({ name: s.name, hsn: s.hsn, qty: 1, unit: 'NOS', rate: s.rate, discount: 0, gst: s.gst, cess: 0 }); render(); hideModal('ai-suggest-modal'); };
                            container.appendChild(btn);
                        });
                    } else { container.textContent = 'No suggestions found.'; }
                } catch (error) { console.error('Error fetching AI suggestions:', error); container.textContent = `Sorry, something went wrong. ${error.message}`; } finally { loader.classList.add('hidden'); }
            });

            document.getElementById('draft-email-btn').addEventListener('click', async () => {
                if (!validateForm()) { showToast('Please fix errors before drafting.', true); return; }
                const details = appState.currentInvoice.details;
                const totals = calculateTotals(appState.currentInvoice);
                if (!details.recipientName || !details.invoiceNo || totals.grandTotal === 0) { showToast('Please fill recipient, doc no, and add items.', true); return; }
                const loader = document.getElementById('email-draft-loader');
                const content = document.getElementById('email-draft-content');
                const textarea = document.getElementById('email-draft-textarea');
                showModal('email-draft-modal');
                loader.classList.remove('hidden');
                content.classList.add('hidden');
                const docTypeLabel = document.querySelector(`${SELECTORS.documentType} option[value="${details.docType}"]`).textContent;
                const prompt = `Write a polite, professional email to ${details.recipientName} about a ${docTypeLabel} (No. ${details.invoiceNo}) for ‚Çπ${totals.grandTotal.toFixed(2)}. My company is ${details.supplierName}. The email should have a clear subject, friendly greeting, mention the attached document and amount, and a professional closing.`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                try {
                    const result = await callGeminiAPI(payload);
                    textarea.value = result.candidates[0].content.parts[0].text;
                } catch (error) { textarea.value = `Sorry, an error occurred while drafting the email. ${error.message}`; } finally { loader.classList.add('hidden'); content.classList.remove('hidden'); }
            });
            document.getElementById('close-email-draft-modal')?.addEventListener('click', () => hideModal('email-draft-modal'));
            document.getElementById('copy-email-btn').addEventListener('click', () => copyTextToClipboard(document.getElementById('email-draft-textarea').value));
            
            function validateForm() {
                document.querySelectorAll('.validation-message').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.input-field.invalid').forEach(el => el.classList.remove('invalid'));
                let isValid = true;
                const { details, items } = appState.currentInvoice;
                const settings = getActiveProfileData().settings;
                const businessType = settings.businessType || 'General';
                let requiredFields = { 'supplier-name': details.supplierName, 'supplier-address': details.supplierAddress, 'supplier-pincode': details.supplierPincode, 'recipient-pincode': details.recipientPincode, 'invoice-date': details.invoiceDate };
                
                // Only require supplier GSTIN if it's not a Bill of Supply
                if (details.docType !== 'bill_of_supply') {
                    requiredFields['supplier-gstin'] = details.supplierGstin;
                }

                const isSpecialType = ['Banking/NBFC', 'Passenger Transport'].includes(businessType);
                if (!isSpecialType) requiredFields['invoice-no'] = details.invoiceNo;
                if (details.transactionType === 'b2c') {
                    const taxableValue = calculateTotals(appState.currentInvoice).subtotal;
                    const addDetailsCheckbox = document.getElementById('add-recipient-details');
                    if (taxableValue >= 50000 || (taxableValue < 50000 && addDetailsCheckbox.checked)) {
                        requiredFields['recipient-name'] = details.recipientName;
                        if (!isSpecialType) requiredFields['recipient-address'] = details.recipientAddress;
                    }
                } else {
                    requiredFields['recipient-name'] = details.recipientName;
                    requiredFields['recipient-gstin'] = details.recipientGstin;
                    if (!isSpecialType) requiredFields['recipient-address'] = details.recipientAddress;
                }
                for (const id in requiredFields) {
                    if (!requiredFields[id] || (typeof requiredFields[id] === 'string' && requiredFields[id].trim() === '')) {
                        isValid = false;
                        const field = document.getElementById(id);
                        const errorEl = document.getElementById(`${id}-error`);
                        if(field) field.classList.add('invalid');
                        if(errorEl) { errorEl.textContent = 'This field is required.'; errorEl.classList.remove('hidden'); }
                    }
                }
                if (items.length === 0) { isValid = false; showToast('Please add at least one item.', true); } 
                else {
                    const itemRows = document.querySelectorAll('#invoice-items tr');
                    items.forEach((item, index) => {
                         const row = itemRows[index];
                         if (!item.name) { isValid = false; if(row) row.querySelector('.item-name')?.classList.add('invalid'); }
                         if (details.transactionType === 'b2b' && !item.hsn) { isValid = false; if(row) row.querySelector('.item-hsn')?.classList.add('invalid'); }
                    });
                }
                document.querySelectorAll(`${SELECTORS.actionButtons} button`).forEach(btn => { if(btn.id !== 'new-invoice-btn' && btn.id !== 'generate-eway-json-btn') btn.disabled = !isValid; });
                document.querySelector(SELECTORS.generateEwayJsonBtn).disabled = !(isValid && calculateTotals(appState.currentInvoice).grandTotal > 50000);
                return isValid;
            }

            function renderProfileSelector() {
                document.querySelector(SELECTORS.clientSelector).innerHTML = appState.profiles.map(p => `<option value="${p.id}" ${p.id === appState.activeProfileId ? 'selected' : ''}>${p.name}</option>`).join('');
            }
            
            function switchProfile(profileId) {
                appState.activeProfileId = profileId;
                saveDataToLocalStorage();
                renderAll();
            }

            function autoFillInvoiceNumber() {
                const settings = getActiveProfileData().settings;
                const nextNumber = settings.lastInvoiceNumber + 1;
                const paddedNumber = String(nextNumber).padStart(3, '0');
                appState.currentInvoice.details.invoiceNo = settings.invoicePrefix + paddedNumber;
            }

            function renderAll() {
                renderProfileSelector();
                render();
                renderProductsTable();
                renderCustomersTable();
                renderInvoicesTable();
                renderRecurringTable();
                renderExpensesTable();
                renderDailySalesTable();
                populateDatalists();
                renderProfileList();
                updateDashboard();
            }

            document.querySelector(SELECTORS.clientSelector).addEventListener('change', (e) => switchProfile(e.target.value));
            
            function renderProfileList() {
                document.querySelector(SELECTORS.profileListManage).innerHTML = appState.profiles.map(profile => {
                    const settings = (appState.profileData[profile.id] || getInitialProfileData()).settings;
                    return `<div class="p-3 border rounded-lg"><div class="flex justify-between items-center"><span class="font-semibold">${profile.name}</span><div><button class="text-blue-500 text-xs edit-profile-btn" data-id="${profile.id}">Settings</button><button class="text-red-500 text-xs delete-profile-btn ml-2" data-id="${profile.id}">Delete</button></div></div><div id="profile-settings-${profile.id}" class="hidden mt-4 space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="business-type-${profile.id}" class="text-sm font-medium">Business Type</label><select id="business-type-${profile.id}" class="input-field mt-1"><option value="General" ${settings.businessType === 'General' ? 'selected' : ''}>General Business</option><option value="Goods Transport Agency" ${settings.businessType === 'Goods Transport Agency' ? 'selected' : ''}>Goods Transport Agency</option><option value="Banking/NBFC" ${settings.businessType === 'Banking/NBFC' ? 'selected' : ''}>Banking/NBFC</option><option value="Passenger Transport" ${settings.businessType === 'Passenger Transport' ? 'selected' : ''}>Passenger Transport</option></select></div><div class="flex items-center pt-6"><label class="flex items-center"><input type="checkbox" id="composition-scheme-${profile.id}" class="h-4 w-4" ${settings.isCompositionScheme ? 'checked' : ''}><span class="ml-2 text-sm">This profile is under GST Composition Scheme.</span></label></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="flex items-center gap-4"><img id="logo-preview-${profile.id}" src="${settings.logo || 'https://placehold.co/100x40/eee/ccc?text=Logo'}" class="w-24 h-auto border"><input type="file" id="logo-upload-${profile.id}" class="input-field text-xs" accept="image/*"></div><div class="flex items-center gap-4"><img id="signatory-preview-${profile.id}" src="${settings.signatoryImage || 'https://placehold.co/100x40/eee/ccc?text=Signature'}" class="w-24 h-auto border"><input type="file" id="signatory-upload-${profile.id}" class="input-field text-xs" accept="image/*"></div></div><textarea class="input-field" id="terms-${profile.id}" rows="2">${settings.paymentTerms}</textarea><textarea class="input-field" id="bank-${profile.id}" rows="2">${settings.bankDetails}</textarea><div class="grid grid-cols-2 gap-4"><div><label for="prefix-${profile.id}" class="text-sm font-medium">Invoice Prefix</label><input type="text" id="prefix-${profile.id}" class="input-field mt-1" value="${settings.invoicePrefix}"></div><div><label for="last-no-${profile.id}" class="text-sm font-medium">Last Invoice No.</label><input type="number" id="last-no-${profile.id}" class="input-field mt-1" value="${settings.lastInvoiceNumber}"></div></div><div class="md:col-span-2 mt-2"><label for="api-key-${profile.id}" class="text-sm font-medium">Gemini API Key (for AI Features)</label><input type="password" id="api-key-${profile.id}" class="input-field mt-1" value="${settings.geminiApiKey || ''}" placeholder="Enter your Google AI Studio API Key"><p class="text-xs text-gray-500 mt-1">Your key is stored locally in your browser and is required for AI features to work.</p></div><button class="btn-primary text-sm save-profile-settings-btn mt-4" data-id="${profile.id}">Save Settings</button></div></div>`;
                }).join('');
            }

            document.querySelector(SELECTORS.profileListManage).addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                if (e.target.classList.contains('edit-profile-btn')) {
                    document.getElementById(`profile-settings-${id}`).classList.toggle('hidden');
                } else if (e.target.classList.contains('delete-profile-btn')) {
                    if (appState.profiles.length === 1) { showToast("Cannot delete the last profile.", true); return; }
                    showDeleteConfirmation('Delete this profile and all its data?', () => {
                        const wasActive = appState.activeProfileId === id;
                        appState.profiles = appState.profiles.filter(p => p.id !== id);
                        delete appState.profileData[id];
                        if (wasActive) appState.activeProfileId = appState.profiles[0].id;
                        saveDataToLocalStorage();
                        renderAll();
                    });
                } else if (e.target.classList.contains('save-profile-settings-btn')) {
                    const profileSettings = appState.profileData[id].settings;
                    profileSettings.businessType = document.getElementById(`business-type-${id}`).value;
                    profileSettings.isCompositionScheme = document.getElementById(`composition-scheme-${id}`).checked;
                    profileSettings.paymentTerms = document.getElementById(`terms-${id}`).value;
                    profileSettings.bankDetails = document.getElementById(`bank-${id}`).value;
                    profileSettings.invoicePrefix = document.getElementById(`prefix-${id}`).value;
                    profileSettings.lastInvoiceNumber = parseInt(document.getElementById(`last-no-${id}`).value) || 0;
                    profileSettings.geminiApiKey = document.getElementById(`api-key-${id}`).value.trim();
                    
                    const readFileAsDataURL = (file) => new Promise((resolve) => {
                        if (!file) return resolve(null);
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(file);
                    });

                    Promise.all([
                        readFileAsDataURL(document.getElementById(`logo-upload-${id}`).files[0]),
                        readFileAsDataURL(document.getElementById(`signatory-upload-${id}`).files[0])
                    ]).then(([logo, signatory]) => {
                        if (logo) profileSettings.logo = logo;
                        if (signatory) profileSettings.signatoryImage = signatory;
                        saveDataToLocalStorage();
                        renderAll();
                        showToast('Profile settings saved!');
                        document.getElementById(`profile-settings-${id}`).classList.add('hidden');
                    });
                }
            });

            document.querySelector(SELECTORS.addProfileForm)?.addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = document.querySelector(SELECTORS.newProfileNameInput).value.trim();
                if (newName) {
                    const newId = String(Date.now());
                    appState.profiles.push({ id: newId, name: newName });
                    appState.profileData[newId] = getInitialProfileData();
                    saveDataToLocalStorage();
                    renderAll();
                    document.querySelector(SELECTORS.newProfileNameInput).value = '';
                    showToast('Profile added!');
                }
            });

            document.querySelector(SELECTORS.generatePdfBtn).addEventListener('click', () => {
                const isVoucher = ['payment_voucher', 'receipt_voucher', 'refund_voucher'].includes(appState.currentInvoice.details.docType);
                if (isVoucher) generateVoucherPDF(); else generateInvoicePDF();
            });

            const generateInvoicePDF = () => {
                if (!validateForm()) { showToast('Please fix errors before generating PDF.', true); return; }
                const { jsPDF } = window.jspdf;
                const invoicePreview = document.createElement('div');
                invoicePreview.className = 'p-8 bg-white text-black';
                invoicePreview.style.width = '210mm';
                
                const details = JSON.parse(JSON.stringify(appState.currentInvoice.details));
                const settings = getActiveProfileData().settings;
                const docTypeSelect = document.getElementById('document-type');
                let docTypeLabel = docTypeSelect.options[docTypeSelect.selectedIndex].text;
                let declarationHtml = '';

                if (details.isConsolidated) {
                    docTypeLabel = 'Consolidated Tax Invoice';
                    declarationHtml = `<p style="text-align: center; font-size: 8px; font-style: italic;">(As per rule 46 of CGST Rules, 2017)</p>`;
                }

                details.docType = docTypeSelect.value; 
                const showPriceAndTax = details.docType !== 'delivery_challan';
                const showTaxColumns = !NO_TAX_DOC_TYPES.includes(details.docType);
                const invoiceCopyType = document.getElementById('invoice-copy-type').value || 'Original for Recipient';
                const isComposition = settings.isCompositionScheme && details.docType === 'bill_of_supply';
                const compositionSchemeHtml = isComposition ? '<p style="font-weight: bold; text-align: center; margin-top: 1rem; font-size: 9px;">Composition taxable person</p>' : '';
                const reverseChargeHtml = (details.reverseCharge && details.docType !== 'self_invoice_rcm') ? '<p style="font-weight: bold; text-align: center; margin-top: 1rem;">Tax on Reverse Charge</p>' : '';
                
                let tableHeadHtml = '';
                let totalsHtml = '';

                const itemsHtml = appState.currentInvoice.items.map((item, index) => {
                    let rowHtml = `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 8px 4px; text-align: center;">${index + 1}</td><td style="padding: 8px 4px;">${item.name}</td><td style="padding: 8px 4px;">${item.hsn}</td><td style="padding: 8px 4px; text-align: center;">${item.qty}</td><td style="padding: 8px 4px; text-align: center;">${item.unit}</td>`;
                    if (showPriceAndTax) {
                        const taxableValue = safeParseFloat(item.qty) * safeParseFloat(item.rate) - safeParseFloat(item.discount);
                        let itemTotal = taxableValue;
                        if(showTaxColumns || details.docType === 'invoice_cum_bill_of_supply') {
                             itemTotal += (taxableValue * (safeParseFloat(item.gst) + safeParseFloat(item.cess))) / 100;
                        }
                        rowHtml += `<td style="padding: 8px 4px; text-align: right;">${safeParseFloat(item.rate).toFixed(2)}</td><td style="padding: 8px 4px; text-align: right;">${safeParseFloat(item.discount || 0).toFixed(2)}</td><td style="padding: 8px 4px; text-align: right;">${taxableValue.toFixed(2)}</td>`;
                        if (showTaxColumns || details.docType === 'invoice_cum_bill_of_supply') {
                             rowHtml += `<td style="padding: 8px 4px; text-align: right;">${item.gst}%</td><td style="padding: 8px 4px; text-align: right;">${item.cess || 0}%</td>`;
                        }
                        rowHtml += `<td style="padding: 8px 4px; text-align: right;">${itemTotal.toFixed(2)}</td>`;
                    }
                    rowHtml += '</tr>';
                    return rowHtml;
                }).join('');

                tableHeadHtml = `<tr><th style="padding: 4px; text-align: center;">Sr.</th><th style="padding: 4px;">Item</th><th style="padding: 4px;">HSN/SAC</th><th style="padding: 4px; text-align: center;">Qty</th><th style="padding: 4px; text-align: center;">Unit</th>`;
                if(showPriceAndTax) {
                    tableHeadHtml += `<th style="padding: 4px; text-align: right;">Rate</th><th style="padding: 4px; text-align: right;">Discount</th><th style="padding: 4px; text-align: right;">Taxable</th>`;
                    if(showTaxColumns || details.docType === 'invoice_cum_bill_of_supply') {
                         tableHeadHtml += `<th style="padding: 4px; text-align: right;">GST%</th><th style="padding: 4px; text-align: right;">Cess%</th>`;
                    }
                    tableHeadHtml += `<th style="padding: 4px; text-align: right;">Total</th>`;
                }
                tableHeadHtml += `</tr>`;

                if (details.docType === 'invoice_cum_bill_of_supply') {
                    docTypeLabel = "Invoice-cum-Bill of Supply";
                    declarationHtml += `<p style="text-align: center; font-size: 8px; font-style: italic; margin-bottom: 1rem;">This document serves as an Invoice for taxable supplies and a Bill of Supply for exempt supplies.</p>`;
                    
                    let taxableValue = 0;
                    let exemptValue = 0;
                    let cgst = 0, sgst = 0, igst = 0, cess = 0;
                    const interStateCheck = isInterState(details.supplierGstin, details.placeOfSupply);

                    appState.currentInvoice.items.forEach(item => {
                        const itemValue = (safeParseFloat(item.qty) * safeParseFloat(item.rate)) - safeParseFloat(item.discount);
                        if (safeParseFloat(item.gst) > 0) {
                            taxableValue += itemValue;
                            const taxAmount = (itemValue * safeParseFloat(item.gst)) / 100;
                            cess += (itemValue * safeParseFloat(item.cess)) / 100;
                            if (interStateCheck) {
                                igst += taxAmount;
                            } else {
                                cgst += taxAmount / 2;
                                sgst += taxAmount / 2;
                            }
                        } else {
                            exemptValue += itemValue;
                        }
                    });

                    const additionalCharges = safeParseFloat(details.packagingHandlingCharges) + safeParseFloat(details.deliveryCharges) + safeParseFloat(details.cashHandlingCharges);
                    
                    if (additionalCharges > 0) {
                        taxableValue += additionalCharges;
                        const highestGstRate = appState.currentInvoice.items.length > 0 ? Math.max(...appState.currentInvoice.items.map(item => safeParseFloat(item.gst))) : 0;
                        if (highestGstRate > 0) {
                            const taxOnCharges = (additionalCharges * highestGstRate) / 100;
                             if (interStateCheck) { igst += taxOnCharges; } else { cgst += taxOnCharges / 2; sgst += taxOnCharges / 2; }
                        }
                    }

                    const totalBeforeRewards = taxableValue + exemptValue + cgst + sgst + igst + cess;
                    const rewardsUsed = safeParseFloat(details.rewardsUsed);
                    const totalAfterRewards = totalBeforeRewards - rewardsUsed;
                    const grandTotal = Math.round(totalAfterRewards);
                    const roundOff = grandTotal - totalAfterRewards;

                    totalsHtml = `<div style="display: flex; justify-content: space-between;"><span>Taxable Value:</span> <span>‚Çπ${(taxableValue - additionalCharges).toFixed(2)}</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>Exempt Value:</span> <span>‚Çπ${exemptValue.toFixed(2)}</span></div>`;
                    if (safeParseFloat(details.packagingHandlingCharges) > 0) totalsHtml += `<div style="display: flex; justify-content: space-between;"><span>Packaging & Handling:</span> <span>‚Çπ${safeParseFloat(details.packagingHandlingCharges).toFixed(2)}</span></div>`;
                    if (safeParseFloat(details.deliveryCharges) > 0) totalsHtml += `<div style="display: flex; justify-content: space-between;"><span>Delivery Charges:</span> <span>‚Çπ${safeParseFloat(details.deliveryCharges).toFixed(2)}</span></div>`;
                    if (safeParseFloat(details.cashHandlingCharges) > 0) totalsHtml += `<div style="display: flex; justify-content: space-between;"><span>Cash Handling:</span> <span>‚Çπ${safeParseFloat(details.cashHandlingCharges).toFixed(2)}</span></div>`;
                    totalsHtml += `<div style="display: flex; justify-content: space-between;"><span>CGST:</span> <span>‚Çπ${cgst.toFixed(2)}</span></div>
                                 <div style="display: flex; justify-content: space-between;"><span>SGST/UTGST:</span> <span>‚Çπ${sgst.toFixed(2)}</span></div>
                                 <div style="display: flex; justify-content: space-between;"><span>IGST:</span> <span>‚Çπ${igst.toFixed(2)}</span></div>
                                 <div style="display: flex; justify-content: space-between;"><span>Cess:</span> <span>‚Çπ${cess.toFixed(2)}</span></div>
                                 <div style="display: flex; justify-content: space-between;"><span>Round Off:</span> <span>‚Çπ${roundOff.toFixed(2)}</span></div>`;
                    if (rewardsUsed > 0) {
                        totalsHtml += `<div style="display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid #ccc; margin-top: 0.25rem; padding-top: 0.25rem;"><span>Total Before Rewards:</span> <span>‚Çπ${totalBeforeRewards.toFixed(2)}</span></div>`;
                        totalsHtml += `<div style="display: flex; justify-content: space-between; color: green;"><span>Rewards Used:</span> <span>- ‚Çπ${rewardsUsed.toFixed(2)}</span></div>`;
                    }
                    totalsHtml += `<div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 11px; border-top: 2px solid #000; margin-top: 0.5rem; padding-top: 0.5rem;"><span>GRAND TOTAL:</span> <span>‚Çπ${grandTotal.toFixed(2)}</span></div>`;
                } 
                else {
                    const totals = calculateTotals(appState.currentInvoice);
                    totalsHtml = `<div style="display: flex; justify-content: space-between;"><span>Subtotal:</span> <span>‚Çπ${totals.subtotal.toFixed(2)}</span></div>`;
                    if (safeParseFloat(details.packagingHandlingCharges) > 0) totalsHtml += `<div style="display: flex; justify-content: space-between;"><span>Packaging & Handling:</span> <span>‚Çπ${safeParseFloat(details.packagingHandlingCharges).toFixed(2)}</span></div>`;
                    if (safeParseFloat(details.deliveryCharges) > 0) totalsHtml += `<div style="display: flex; justify-content: space-between;"><span>Delivery Charges:</span> <span>‚Çπ${safeParseFloat(details.deliveryCharges).toFixed(2)}</span></div>`;
                    if (safeParseFloat(details.cashHandlingCharges) > 0) totalsHtml += `<div style="display: flex; justify-content: space-between;"><span>Cash Handling:</span> <span>‚Çπ${safeParseFloat(details.cashHandlingCharges).toFixed(2)}</span></div>`;
                    if(showTaxColumns) totalsHtml += `<div style="display: flex; justify-content: space-between;"><span>CGST:</span> <span>‚Çπ${totals.cgst.toFixed(2)}</span></div><div style="display: flex; justify-content: space-between;"><span>SGST/UTGST:</span> <span>‚Çπ${totals.sgst.toFixed(2)}</span></div><div style="display: flex; justify-content: space-between;"><span>IGST:</span> <span>‚Çπ${totals.igst.toFixed(2)}</span></div><div style="display: flex; justify-content: space-between;"><span>Cess:</span> <span>‚Çπ${totals.cess.toFixed(2)}</span></div>`;
                    totalsHtml += `<div style="display: flex; justify-content: space-between;"><span>Round Off:</span> <span>‚Çπ${totals.roundOff.toFixed(2)}</span></div>`;
                    if (totals.rewardsUsed > 0) totalsHtml += `<div style="display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid #ccc; margin-top: 0.25rem; padding-top: 0.25rem;"><span>Total Before Rewards:</span> <span>‚Çπ${totals.totalBeforeRewards.toFixed(2)}</span></div><div style="display: flex; justify-content: space-between; color: green;"><span>Rewards Used:</span> <span>- ‚Çπ${totals.rewardsUsed.toFixed(2)}</span></div>`;
                    totalsHtml += `<div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 11px; border-top: 2px solid #000; margin-top: 0.5rem; padding-top: 0.5rem;"><span>GRAND TOTAL:</span> <span>‚Çπ${totals.grandTotal.toFixed(2)}</span></div>`;
                }

                const gtaDetailsHtml = settings.businessType === 'Goods Transport Agency' ? `...` : '';
                const originalDocHtml = ['debit_note', 'credit_note', 'refund_voucher'].includes(details.docType) ? `<p><strong>Original Doc No:</strong> ${details.originalInvoiceNo}</p><p><strong>Original Doc Date:</strong> ${details.originalInvoiceDate}</p>` : '';
                const irnHtml = details.irn ? `<div id="qrcode-container">...</div>` : '';
                const placeOfSupplyText = `${details.placeOfSupply} (${appState.indianStates[details.placeOfSupply]})`;
                const logoHtml = settings.logo ? `<img src="${settings.logo}" style="max-height: 40px;">` : '';
                const signatoryHtml = settings.signatoryImage ? `<img src="${settings.signatoryImage}" style="max-height: 40px;">` : `<p>Authorised Signatory</p>`;
                let billToHtml = '', supplierHtml = '', shipToHtml = '';
                
                if(details.docType === 'self_invoice_rcm') {
                    supplierHtml = `<div><h3 style="font-weight: bold; font-size: 1.125rem;">${details.supplierName}</h3><p>${details.supplierAddress.replace(/\n/g, '<br>')}</p><p><strong>GSTIN:</strong> ${details.supplierGstin}</p></div>`;
                    billToHtml = `<div><p style="font-weight: bold;">Bill From (Unregistered):</p><p style="font-weight: bold;">${details.unregisteredSupplierName}</p><p>${details.unregisteredSupplierAddress.replace(/\n/g, '<br>')}</p></div>`;
                } else if (details.docType === 'purchase_order') {
                    supplierHtml = `<div><p style="font-weight: bold;">Buyer:</p><h3 style="font-weight: bold; font-size: 1.125rem;">${details.supplierName}</h3><p>${details.supplierAddress.replace(/\n/g, '<br>')}</p><p><strong>GSTIN:</strong> ${details.supplierGstin}</p></div>`;
                    billToHtml = `<div><p style="font-weight: bold;">Seller:</p><p style="font-weight: bold;">${details.recipientName}</p><p>${details.recipientAddress.replace(/\n/g, '<br>')}</p><p><strong>GSTIN:</strong> ${details.recipientGstin || 'N/A'}</p></div>`;
                    if (!details.isServiceInvoice) {
                        shipToHtml = `<div style="text-align: left;"><p style="font-weight: bold;">Deliver To:</p><p style="font-weight: bold;">${details.supplierName}</p><p>${(details.deliveryAddress || details.supplierAddress).replace(/\n/g, '<br>')}</p></div>`;
                    }
                } else {
                    supplierHtml = `<div><h3 style="font-weight: bold; font-size: 1.125rem;">${details.supplierName}</h3><p>${details.supplierAddress.replace(/\n/g, '<br>')}</p><p><strong>GSTIN:</strong> ${details.supplierGstin}</p></div>`;
                    billToHtml = `<div><p style="font-weight: bold;">Bill To:</p><p style="font-weight: bold;">${details.recipientName}</p><p>${details.recipientAddress.replace(/\n/g, '<br>')}</p><p><strong>GSTIN:</strong> ${details.recipientGstin || 'N/A'}</p><p><strong>Place of Supply:</strong> ${placeOfSupplyText}</p></div>`;
                    if (!details.isServiceInvoice) {
                        shipToHtml = `<div style="text-align: left;"><p style="font-weight: bold;">Ship To:</p><p style="font-weight: bold;">${details.recipientName}</p><p>${(details.deliveryAddress || details.recipientAddress).replace(/\n/g, '<br>')}</p></div>`;
                    }
                }
                
                invoicePreview.innerHTML = `<div class="p-8 bg-white" style="font-family: 'Inter', sans-serif; font-size: 10px; color: #000;">${logoHtml}<h2 style="font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 0.25rem;">${docTypeLabel}</h2>${declarationHtml}<p style="text-align: center; font-size: 9px; font-weight: bold; margin-bottom: 1rem;">(${invoiceCopyType})</p><div style="display: flex; justify-content: space-between; align-items: flex-start; font-size: 9px; margin-bottom: 1rem;">${supplierHtml}<div style="text-align: right;"><p><strong>Doc No:</strong> ${details.invoiceNo}</p><p><strong>Doc Date:</strong> ${details.invoiceDate}</p>${originalDocHtml}${details.ewayBillNo ? `<p><strong>E-Way Bill No:</strong> ${details.ewayBillNo}</p>` : ''}</div></div><div style="display: flex; justify-content: space-between; margin: 1rem 0; font-size: 9px;">${billToHtml}${shipToHtml}</div>${gtaDetailsHtml}<table style="width: 100%; text-align: left; margin-bottom: 1rem; font-size: 9px; border-collapse: collapse;"><thead style="background-color: #e5e7eb;"><tr style="font-weight: bold;">${tableHeadHtml}</tr></thead><tbody>${itemsHtml}</tbody></table><div style="display: flex; justify-content: flex-end; font-size: 9px;"><div style="width: 40%;">${totalsHtml}</div></div>${reverseChargeHtml}${compositionSchemeHtml}<div style="margin-top: 1rem; font-size: 8px; display: flex; justify-content: space-between; align-items: flex-end;"><div><p style="font-weight: bold;">Terms & Conditions:</p><p>${settings.paymentTerms.replace(/\n/g, '<br>')}</p><p style="font-weight: bold; margin-top: 0.5rem;">Bank Details:</p><p>${settings.bankDetails.replace(/\n/g, '<br>')}</p></div><div style="text-align: center; width: 200px;"><p style="padding-top: 4px; margin-bottom: 10px;">For ${details.supplierName}</p><div style="height: 40px;">${signatoryHtml}</div></div></div>${irnHtml}</div>`;
                document.body.appendChild(invoicePreview);
                if (details.irn) new QRCode(document.getElementById("qrcode-container"), { text: details.irn, width: 80, height: 80 });
                
                setTimeout(() => { 
                    html2canvas(invoicePreview, { scale: 3 }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        pdf.addImage(imgData, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), (canvas.height * pdf.internal.pageSize.getWidth()) / canvas.width);
                        pdf.save(`${docTypeLabel}-${details.invoiceNo}.pdf`);
                        document.body.removeChild(invoicePreview);
                    });
                }, 100);
            }

            const generateVoucherPDF = () => {
                const { jsPDF } = window.jspdf;
                const voucherPreview = document.createElement('div');
                voucherPreview.className = 'p-8 bg-white text-black';
                voucherPreview.style.width = '210mm';

                const details = appState.currentInvoice.details;
                const profileData = getActiveProfileData();
                const settings = profileData.settings || {};
                const logoHtml = settings.logo ? `<img src="${settings.logo}" style="max-height: 40px; max-width: 150px; margin-bottom: 1rem;">` : '';
                
                const docTypeSelect = document.getElementById('document-type');
                const docTypeLabel = docTypeSelect.options[docTypeSelect.selectedIndex].text;

                let amount = 0;
                let amountLabel = '';
                let extraFields = '';
                if (details.docType === 'receipt_voucher') {
                    amount = details.advanceAmount;
                    amountLabel = 'Amount of Advance Received';
                } else if (details.docType === 'refund_voucher') {
                    amount = details.refundAmount;
                    amountLabel = 'Amount of Refund';
                    extraFields = `<p><strong>Original Receipt Voucher No:</strong> ${details.originalReceiptVoucherNo}</p>`;
                } else if (details.docType === 'payment_voucher') {
                    amount = details.paymentAmount;
                    amountLabel = 'Amount Paid';
                }

                voucherPreview.innerHTML = `
                    <div style="font-family: 'Inter', sans-serif; font-size: 10px; color: #000;">
                        ${logoHtml}
                        <h2 style="font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1rem;">${docTypeLabel}</h2>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <h3 style="font-weight: bold; font-size: 1.125rem;">${details.supplierName}</h3>
                                <p>${details.supplierAddress.replace(/\n/g, '<br>')}</p>
                                <p><strong>GSTIN:</strong> ${details.supplierGstin}</p>
                            </div>
                            <div style="text-align: right;">
                                <p><strong>Voucher No:</strong> ${details.invoiceNo}</p>
                                <p><strong>Voucher Date:</strong> ${details.invoiceDate}</p>
                                ${extraFields}
                            </div>
                        </div>
                        <div style="border-top: 1px solid #ccc; border-bottom: 1px solid #ccc; padding: 1rem 0; margin: 1rem 0;">
                            <p><strong>Description:</strong> ${details.voucherDescription || 'N/A'}</p>
                            <p style="font-size: 1.25rem; font-weight: bold; margin-top: 0.5rem;">${amountLabel}: ‚Çπ${amount.toFixed(2)}</p>
                        </div>
                        <p style="font-size: 8px; margin-top: 2rem;">This is a computer-generated document.</p>
                    </div>
                `;

                 setTimeout(() => { 
                    html2canvas(voucherPreview, { scale: 3 }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save(`${docTypeLabel}-${details.invoiceNo}.pdf`);
                        document.body.removeChild(voucherPreview);
                    });
                }, 100);
             }

            document.getElementById('help-btn').addEventListener('click', () => {
                showModal('help-modal');
                if (!b2bChartInstance) {
                    const ctx = document.getElementById('b2b-b2c-chart').getContext('2d');
                    b2bChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: { labels: ['Recipient GSTIN', 'ITC Available', 'Reporting', 'Value Limit'], datasets: [{ label: 'B2B', data: [10, 10, 8, 10], backgroundColor: '#4A5568' }, { label: 'B2C', data: [0, 0, 4, 6], backgroundColor: '#A0AEC0' }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: function(context) { const type = context.dataset.label; const feature = context.label; const details = { 'B2B': { 'Recipient GSTIN': 'Mandatory', 'ITC Available': 'Yes, for recipient', 'Reporting': 'Detailed in GSTR-1', 'Value Limit': 'No limit for invoicing' }, 'B2C': { 'Recipient GSTIN': 'Not required', 'ITC Available': 'No', 'Reporting': 'Consolidated summary', 'Value Limit': 'Simplified invoice up to ‚Çπ200' } }; return `${type} - ${feature}: ${details[type][feature]}`; } } } }, scales: { y: { display: false } } }
                    });
                }
            });
            document.getElementById('close-help-modal')?.addEventListener('click', () => hideModal('help-modal'));

            function updateDashboard() {
                const invoices = getActiveProfileData().invoices || [];
                let totalBilled = 0, totalCollected = 0;
                const statusCounts = { Draft: 0, Sent: 0, 'Partially Paid': 0, Paid: 0, Overdue: 0 };
                const customerTotals = {};

                invoices.forEach(inv => {
                    if (inv.status !== 'Draft') totalBilled += inv.details.total;
                    const paid = (inv.payments || []).reduce((sum, p) => sum + p.amount, 0);
                    totalCollected += paid;
                    let status = inv.status || 'Draft';
                    if ((status === 'Sent' || status === 'Partially Paid') && inv.details.invoiceDate) {
                        const dueDate = new Date(new Date(inv.details.invoiceDate).setDate(new Date(inv.details.invoiceDate).getDate() + 30));
                        if (new Date() > dueDate) status = 'Overdue';
                    }
                    statusCounts[status]++;
                    if(paid > 0) customerTotals[inv.details.recipientName] = (customerTotals[inv.details.recipientName] || 0) + paid;
                });

                document.getElementById('kpi-total-billed').textContent = `‚Çπ${totalBilled.toFixed(2)}`;
                document.getElementById('kpi-total-collected').textContent = `‚Çπ${totalCollected.toFixed(2)}`;
                document.getElementById('kpi-total-outstanding').textContent = `‚Çπ${(totalBilled - totalCollected).toFixed(2)}`;

                if (statusChartInstance) statusChartInstance.destroy();
                statusChartInstance = new Chart(document.getElementById('invoice-status-chart').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#d1d5db', '#93c5fd', '#fcd34d', '#86efac', '#fca5a5'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
                
                const sortedCustomers = Object.entries(customerTotals).sort((a, b) => b[1] - a[1]).slice(0, 5);
                if (customerChartInstance) customerChartInstance.destroy();
                customerChartInstance = new Chart(document.getElementById('top-customers-chart').getContext('2d'), { type: 'bar', data: { labels: sortedCustomers.map(c => c[0]), datasets: [{ label: 'Total Paid', data: sortedCustomers.map(c => c[1]), backgroundColor: '#4A5568' }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } } });
                
                updateAgingReport();
            }

            function updateAgingReport() {
                const invoices = getActiveProfileData().invoices || [];
                const agingData = {};
                const today = new Date();

                invoices.forEach(inv => {
                    if (inv.status === 'Paid' || inv.status === 'Draft') return;
                    const totalPaid = (inv.payments || []).reduce((sum, p) => sum + p.amount, 0);
                    const amountDue = inv.details.total - totalPaid;
                    if (amountDue <= 0) return;
                    const dueDate = new Date(new Date(inv.details.invoiceDate).setDate(new Date(inv.details.invoiceDate).getDate() + 30));
                    const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                    const customerName = inv.details.recipientName;
                    if (!agingData[customerName]) {
                        agingData[customerName] = { current: 0, '1-30': 0, '31-60': 0, '61-90': 0, '90+': 0, total: 0 };
                    }
                    if (daysOverdue <= 0) agingData[customerName].current += amountDue;
                    else if (daysOverdue <= 30) agingData[customerName]['1-30'] += amountDue;
                    else if (daysOverdue <= 60) agingData[customerName]['31-60'] += amountDue;
                    else if (daysOverdue <= 90) agingData[customerName]['61-90'] += amountDue;
                    else agingData[customerName]['90+'] += amountDue;
                    agingData[customerName].total += amountDue;
                });

                const tbody = document.getElementById('aging-report-table');
                tbody.innerHTML = Object.entries(agingData).map(([name, data]) => `
                    <tr class="border-b">
                        <td class="p-2 font-medium">${name}</td>
                        <td class="p-2 text-right">‚Çπ${data.current.toFixed(2)}</td>
                        <td class="p-2 text-right">‚Çπ${data['1-30'].toFixed(2)}</td>
                        <td class="p-2 text-right">‚Çπ${data['31-60'].toFixed(2)}</td>
                        <td class="p-2 text-right">‚Çπ${data['61-90'].toFixed(2)}</td>
                        <td class="p-2 text-right">‚Çπ${data['90+'].toFixed(2)}</td>
                        <td class="p-2 text-right font-bold">‚Çπ${data.total.toFixed(2)}</td>
                    </tr>
                `).join('');
            }

            function checkAndGenerateRecurringInvoices() {
                const profileData = getActiveProfileData();
                const today = new Date(); today.setHours(0,0,0,0);
                let hasChanges = false;
                
                (profileData.recurring || []).forEach(schedule => {
                    if (new Date(schedule.nextDueDate) <= today) {
                        hasChanges = true;
                        const newInvoice = JSON.parse(JSON.stringify(schedule.templateInvoice));
                        profileData.settings.lastInvoiceNumber++;
                        newInvoice.details.invoiceNo = profileData.settings.invoicePrefix + String(profileData.settings.lastInvoiceNumber).padStart(3, '0');
                        newInvoice.details.invoiceDate = new Date().toISOString().slice(0, 10);
                        newInvoice.status = 'Draft';
                        newInvoice.payments = [];
                        profileData.invoices.push(newInvoice);
                        const newNextDate = new Date(schedule.nextDueDate);
                        if (schedule.frequency === 'monthly') newNextDate.setMonth(newNextDate.getMonth() + 1);
                        else if (schedule.frequency === 'quarterly') newNextDate.setMonth(newNextDate.getMonth() + 3);
                        else if (schedule.frequency === 'annually') newNextDate.setFullYear(newNextDate.getFullYear() + 1);
                        schedule.nextDueDate = newNextDate.toISOString().slice(0,10);
                    }
                });
                if (hasChanges) {
                    saveDataToLocalStorage();
                    showToast('Recurring invoice(s) generated.');
                }
            }

            function generateGstSummary() {
                const startDate = document.getElementById('gst-start-date').value;
                const endDate = document.getElementById('gst-end-date').value;
                if (!startDate || !endDate || new Date(startDate) > new Date(endDate)) { showToast('Please select a valid date range.', true); return; }
                const invoices = getActiveProfileData().invoices || [];
                const filteredInvoices = invoices.filter(inv => {
                    const invDate = new Date(inv.details.invoiceDate);
                    return inv.status !== 'Draft' && invDate >= new Date(startDate) && invDate <= new Date(endDate);
                });

                let totalTaxable = 0, totalCgst = 0, totalSgst = 0, totalIgst = 0, totalCess = 0;
                filteredInvoices.forEach(inv => {
                    const totals = calculateTotals(inv);
                    totalTaxable += totals.subtotal;
                    totalCgst += totals.cgst;
                    totalSgst += totals.sgst;
                    totalIgst += totals.igst;
                    totalCess += totals.cess;
                });

                document.getElementById('report-period').textContent = `${startDate} to ${endDate}`;
                document.getElementById('report-taxable-value').textContent = `‚Çπ${totalTaxable.toFixed(2)}`;
                document.getElementById('report-total-cgst').textContent = `‚Çπ${totalCgst.toFixed(2)}`;
                document.getElementById('report-total-sgst').textContent = `‚Çπ${totalSgst.toFixed(2)}`;
                document.getElementById('report-total-igst').textContent = `‚Çπ${totalIgst.toFixed(2)}`;
                document.getElementById('report-total-cess').textContent = `‚Çπ${totalCess.toFixed(2)}`;
                document.getElementById('gst-report-content').classList.remove('hidden');
            }
            const gstRateData = [
                // Schedule I (5%)
                { description: "Live horses", newRate: "5%" },
                { description: "Milk and cream, condensed or with added sugar", newRate: "5%" },
                { description: "Yoghurt, Lassi, Butter milk (Pre-packaged, labelled)", newRate: "5%" },
                { description: "Butter, ghee, dairy spreads", newRate: "5%" },
                { description: "Cheese (other than paneer)", newRate: "5%" },
                { description: "Natural honey (Pre-packaged, labelled)", newRate: "5%" },
                { description: "Cashew nuts, dried coconut, Brazil nuts", newRate: "5%" },
                { description: "Dried areca nuts, almonds, hazelnuts, pistachios, walnuts", newRate: "5%" },
                { description: "Dried dates, figs, pineapples, avocados, guavas, mangoes", newRate: "5%" },
                { description: "Dried citrus fruit (oranges, lemons)", newRate: "5%" },
                { description: "Dried grapes, raisins", newRate: "5%" },
                { description: "Roasted coffee", newRate: "5%" },
                { description: "Tea (except unprocessed green leaves)", newRate: "5%" },
                { description: "Spices like pepper, vanilla, cinnamon, cloves, nutmeg, mace, cardamoms, anise, coriander, cumin", newRate: "5%" },
                { description: "Wheat, meslin, rye, barley, oats, maize (corn), rice, grain sorghum, buckwheat, millet (Jawar, Bajra, Ragi) - pre-packaged and labelled", newRate: "5%" },
                { description: "Wheat, meslin, cereal flours (pre-packaged and labelled)", newRate: "5%" },
                { description: "Suji and dalia (pre-packaged and labelled)", newRate: "5%" },
                { description: "Soya-bean oil, Ground-nut oil, Olive oil, Palm oil, Sunflower oil, Mustard oil", newRate: "5%" },
                { description: "Sausages and similar meat products", newRate: "5%" },
                { description: "Jaggery (gur), Khandsari Sugar (pre-packaged and labelled)", newRate: "5%" },
                { description: "Sugar confectionary (not containing cocoa), Sugar boiled confectionary", newRate: "5%" },
                { description: "Chocolates and food preparations containing cocoa", newRate: "5%" },
                { description: "Pasta, noodles, couscous, vermicelli (seviyan)", newRate: "5%" },
                { description: "Corn flakes, bulgar wheat", newRate: "5%" },
                { description: "Pastry, cakes, biscuits, rusks, toasted bread", newRate: "5%" },
                { description: "Jams, fruit jellies, marmalades", newRate: "5%" },
                { description: "Fruit juices, vegetable juices", newRate: "5%" },
                { description: "Tender coconut water (pre-packaged and labelled)", newRate: "5%" },
                { description: "Sauces, curry paste, mayonnaise, salad dressings", newRate: "5%" },
                { description: "Ice cream and other edible ice", newRate: "5%" },
                { description: "Namkeens, bhujia, mixture, chabena (pre-packaged and labelled)", newRate: "5%" },
                { description: "Plant-based milk drinks, Soya milk drinks", newRate: "5%" },
                { description: "Talcum powder, Face powder", newRate: "5%" },
                { description: "Hair oil, shampoo", newRate: "5%" },
                { description: "Toothpaste, Dental floss", newRate: "5%" },
                { description: "Shaving cream, shaving lotion, aftershave lotion", newRate: "5%" },
                { description: "Agarbatti and other odoriferous preparations which operate by burning", newRate: "5%" },
                { description: "Toilet Soap (bars, cakes)", newRate: "5%" },
                { description: "Candles, tapers and the like", newRate: "5%" },
                { description: "All Drugs and medicines", newRate: "5%" },
                { description: "Bicycles and other non-motorized cycles", newRate: "5%" },
                { description: "Parts and accessories of bicycles", newRate: "5%" },
                { description: "Footwear of sale value not exceeding Rs. 2500 per pair", newRate: "5%" },
                { description: "Hotel accommodation services, where value of supply is up to Rs. 7500 per unit per day", newRate: "5% (without ITC)" },
                { description: "Beauty and physical well-being services (health clubs, salons, barbers, fitness centers, yoga)", newRate: "5% (without ITC)" },
                // Schedule II (18%)
                { description: "Artificial honey", newRate: "18%" },
                { description: "Vinegar and substitutes for vinegar", newRate: "18%" },
                { description: "Marble and travertine (other than blocks)", newRate: "18%" },
                { description: "Granite (other than blocks)", newRate: "18%" },
                { description: "Portland cement, aluminous cement, slag cement", newRate: "18%" },
                { description: "Paints and varnishes", newRate: "18%" },
                { description: "Perfumes and toilet waters", newRate: "18%" },
                { description: "Beauty or make-up preparations (other than kajal, kumkum, bindi, sindur, alta)", newRate: "18%" },
                { description: "Air-conditioning machines", newRate: "18%" },
                { description: "Dish washing machines", newRate: "18%" },
                { description: "Television sets (all sizes), Monitors, projectors, set top boxes", newRate: "18%" },
                { description: "Small cars (Petrol/LPG/CNG up to 1200cc & 4000mm length)", newRate: "18%" },
                { description: "Small cars (Diesel up to 1500cc & 4000mm length)", newRate: "18%" },
                { description: "Motorcycles (including mopeds) up to 350cc", newRate: "18%" },
                { description: "Buses, Trucks, Ambulances, 3-Wheelers", newRate: "18%" },
                { description: "Footwear of sale value exceeding Rs.2500 per pair", newRate: "18%" },
                // Schedule III (40%)
                { description: "Aerated waters (containing added sugar or flavour)", newRate: "40%" },
                { description: "Caffeinated Beverages", newRate: "40%" },
                { description: "Motor cars (large), SUVs, and other vehicles not in the 18% slab", newRate: "40%" },
                { description: "Motorcycles of engine capacity exceeding 350 cc", newRate: "40%" },
                { description: "Aircraft for personal use", newRate: "40%" },
                { description: "Yachts and other vessels for pleasure or sports", newRate: "40%" },
                { description: "Revolvers and pistols", newRate: "40%" },
                { description: "Smoking pipes and cigar holders", newRate: "40%" },
                { description: "Specified actionable claims (betting, casinos, gambling, horse racing, lottery, online money gaming)", newRate: "40%" },
                // Other Schedules
                { description: "Precious stones (other than diamonds), semi-precious stones", newRate: "0.25%" },
                { description: "Synthetic or reconstructed precious or semi-precious stones", newRate: "0.25%" },
                { description: "Cut and polished diamonds", newRate: "1.5%" },
                { description: "Silver, Gold, Platinum (unwrought or semi-manufactured)", newRate: "3%" },
                { description: "Articles of jewellery, goldsmiths' or silversmiths' wares", newRate: "3%" },
                { description: "Imitation jewellery", newRate: "3%" },
                { description: "Coin", newRate: "3%" },
                // Nil GST / Exempt
                { description: "UHT milk, chena or paneer (pre-packaged and labelled)", newRate: "NIL" },
                { description: "Pizza bread, khakhra, chapathi or roti, paratha, parotta", newRate: "NIL" },
                { description: "36 specified lifesaving drugs and medicines", newRate: "NIL" },
                { description: "Individual life insurance policies (term, ULIP, endowment)", newRate: "Exempt" },
                { description: "Individual health insurance policies (including family floater, senior citizen)", newRate: "Exempt" },
            ];
            function handleRateFinderSearch() {
                const query = document.getElementById('rate-finder-search').value.toLowerCase();
                const resultsContainer = document.getElementById('rate-finder-results');
                if (!query) {
                    resultsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">Start typing to see results.</p>';
                    return;
                }
                const filteredData = gstRateData.filter(item => item.description.toLowerCase().includes(query));
                if (filteredData.length > 0) {
                    resultsContainer.innerHTML = filteredData.map(item => `
                        <div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                            <span class="text-gray-800">${item.description}</span>
                            <span class="font-bold text-slate-700 text-base">${item.newRate}</span>
                        </div>
                    `).join('');
                } else {
                    resultsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">No matching items found.</p>';
                }
            }

            function initAppUI() {
                Object.keys(appState.indianStates).forEach(stateName => document.querySelector(SELECTORS.placeOfSupply).add(new Option(stateName, stateName)));
                
                const today = new Date();
                document.getElementById('gst-start-date').value = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().slice(0,10);
                document.getElementById('gst-end-date').value = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().slice(0,10);
                document.getElementById('generate-gst-report').addEventListener('click', generateGstSummary);
                
                document.getElementById('gst-rate-helper-btn').addEventListener('click', () => showModal('gst-rate-helper-modal'));
                document.getElementById('close-gst-rate-helper-modal').addEventListener('click', () => hideModal('gst-rate-helper-modal'));
                document.getElementById('rate-finder-search').addEventListener('input', handleRateFinderSearch);
                document.getElementById('gst-rate-helper-modal').addEventListener('click', (e) => {
                    if (e.target.classList.contains('gst-helper-tab-btn')) {
                        const tab = e.target.dataset.tab;
                        document.querySelectorAll('.gst-helper-tab-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        document.querySelectorAll('.gst-helper-tab-content').forEach(content => content.classList.add('hidden'));
                        document.getElementById(`${tab}-tab-content`).classList.remove('hidden');
                    }
                });

                const dailySaleDateEl = document.getElementById('daily-sale-date');
                dailySaleDateEl.value = new Date().toISOString().slice(0, 10);
                dailySaleDateEl.addEventListener('change', renderDailySalesTable);
                document.getElementById('invoice-copy-type').addEventListener('change', (e) => { appState.currentInvoice.details.invoiceCopyType = e.target.value; });
                document.querySelector(SELECTORS.addRecipientDetails).addEventListener('change', () => render());
                
                document.querySelector(SELECTORS.backupDataBtn).addEventListener('click', () => {
                    const profileName = appState.profiles.find(p => p.id === appState.activeProfileId)?.name || 'profile';
                    downloadFile(`invoice-backup-${profileName}.json`, JSON.stringify(getActiveProfileData(), null, 2), 'application/json');
                });
                
                document.querySelector(SELECTORS.restoreDataBtn).addEventListener('click', () => {
                    const file = document.getElementById('restore-file-input').files[0];
                    if (!file) { showToast('Please select a backup file.', true); return; }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const backupData = JSON.parse(event.target.result);
                            if (!backupData.products || !backupData.customers || !backupData.invoices) throw new Error("Invalid format.");
                            showDeleteConfirmation('Restore will overwrite current data. Continue?', () => {
                                appState.profileData[appState.activeProfileId] = backupData;
                                saveDataToLocalStorage();
                                renderAll();
                                showToast('Data restored!');
                                document.getElementById('restore-file-input').value = '';
                            });
                        } catch (error) { showToast(`Error restoring: ${error.message}`, true); }
                    };
                    reader.readAsText(file);
                });

                setupModals();
                resetInvoiceState();
                renderAll();
                navigate('#create-invoice');
                appLoader.classList.add('hidden');
                mainApp.classList.remove('hidden');
            }
            
            // Start data loading process
            loadDataFromLocalStorage();
            checkAndGenerateRecurringInvoices();
            initAppUI();
        }
    </script>
</body>
</html>






